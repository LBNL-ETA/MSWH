

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>mswh.system.components &mdash; Multiscale Solar Water Heating 1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Multiscale Solar Water Heating
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../source/models.html">Multiscale Solar Water Heating (MSWH)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/modules.html">Python Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/legal.html">Copyright Notice</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/legal.html#license-agreement">License Agreement</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Multiscale Solar Water Heating</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>mswh.system.components</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for mswh.system.components</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">from</span> <span class="nn">mswh.comm.label_map</span> <span class="k">import</span> <span class="n">SwhLabels</span>
<span class="kn">from</span> <span class="nn">mswh.tools.unit_converters</span> <span class="k">import</span> <span class="n">UnitConv</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="Converter"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Converter">[docs]</a><span class="k">class</span> <span class="nc">Converter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Contains energy converter models, such as</span>
<span class="sd">    solar collectors, electric resistance heaters, gas burners,</span>
<span class="sd">    photovoltaic panels, and heat pumps. Depending on the intended</span>
<span class="sd">    usage, the models can be used to determine either a time period</span>
<span class="sd">    of component operation (for example an entire year), or a single</span>
<span class="sd">    timestep of component performance.</span>

<span class="sd">    Parameters:</span>

<span class="sd">        params: pd df</span>
<span class="sd">            Component performance parameters per project</span>
<span class="sd">            Default: None (default model parameters will get used)</span>

<span class="sd">        weather: pd df</span>
<span class="sd">            Weather data timeseeries with columns: amb. temp,</span>
<span class="sd">            solar irradiation. Number of rows equals the number of timesteps.</span>
<span class="sd">            Default: None (constant values will be set - use for</span>
<span class="sd">            a single timestep calculation, or if passing arguments</span>
<span class="sd">            directly to static methods)</span>

<span class="sd">        sizes: pd df</span>
<span class="sd">            Component sizes per project.</span>
<span class="sd">            Default: 1. (see individual components for specifics)</span>

<span class="sd">        log_level: None or python logger logging level,</span>
<span class="sd">            Default: logging.DEBUG</span>
<span class="sd">            This applies for a subset of the class functionality, mostly</span>
<span class="sd">            used to deprecate logger messages for certain calculations.</span>
<span class="sd">            For Example: log_level = logging.ERROR will only throw error</span>
<span class="sd">            messages and ignore INFO, DEBUG and WARNING.</span>

<span class="sd">    Note:</span>

<span class="sd">        If more than one of the same component is a part of the</span>
<span class="sd">        system, a separate instance of the converter should</span>
<span class="sd">        be created for each instance of the component.</span>

<span class="sd">        Each component is also implemented as a static method that</span>
<span class="sd">        can be used outside of this framework.</span>

<span class="sd">    Examples:</span>

<span class="sd">        See ```swh.system.tests.test_components``` module and</span>
<span class="sd">        ```scripts/Project Level SWH System Tool.ipynb```</span>
<span class="sd">        for examples on how to use the methods as stand alone and</span>
<span class="sd">        in a system model simulation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weather</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sizes</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
                 <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>

        <span class="c1"># log level (e.g. only partial functionality of the class</span>
        <span class="c1"># is being used and one does not desire to see all infos)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="n">log_level</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

        <span class="c1"># extract labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">SwhLabels</span><span class="p">()</span><span class="o">.</span><span class="n">set_hous_labels</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">SwhLabels</span><span class="p">()</span><span class="o">.</span><span class="n">set_prod_labels</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">SwhLabels</span><span class="p">()</span><span class="o">.</span><span class="n">set_res_labels</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">use_defaults</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># extract components and their performance parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># extract components provided in params</span>
            <span class="n">components</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;sol_col&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;sol_col&#39;</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_sol_col</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="c1"># this method of collector model selection prefers the</span>
                <span class="c1"># model under ```try:``` as long as the parameters were</span>
                <span class="c1"># found in the parameter table</span>
                <span class="k">try</span><span class="p">:</span> <span class="c1"># HWB</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params_sol_col</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;interc_hwb&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;interc_hwb&#39;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">params_sol_col</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;slope_hwb&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;slope_hwb&#39;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">solar_model</span> <span class="o">=</span> <span class="s1">&#39;HWB&#39;</span>
                <span class="k">except</span><span class="p">:</span> <span class="c1"># CD</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params_sol_col</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;interc_cd&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;interc_cd&#39;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">params_sol_col</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;a1_cd&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;a1_cd&#39;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">params_sol_col</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;a2_cd&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;a2_cd&#39;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">solar_model</span> <span class="o">=</span> <span class="s1">&#39;CD&#39;</span>


            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;pv&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;pv&#39;</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_pv</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="c1"># Extract the model parameters</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_pv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_pv&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_pv&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_pv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;f_act&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;f_act&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_pv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;irrad_ref&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;irrad_ref&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Photovoltaic is setup.&#39;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;inv&#39;</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_inv</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="c1"># extract the total dc-ac conversion efficiency</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_inv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_dc_ac&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_dc_ac&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Inverter is setup.&#39;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="c1"># Extract the model parameters</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c1_cop&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c1_cop&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c2_cop&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c2_cop&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c3_cop&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c3_cop&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c4_cop&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c4_cop&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c5_cop&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c5_cop&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c6_cop&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c6_cop&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c1_heat_cap&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c1_heat_cap&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c2_heat_cap&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c2_heat_cap&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c3_heat_cap&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c3_heat_cap&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c4_heat_cap&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c4_heat_cap&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c5_heat_cap&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c5_heat_cap&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c6_heat_cap&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c6_heat_cap&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;heat_cap_rated&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;heat_cap_rated&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cop_rated&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cop_rated&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Heat pump is setup.&#39;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;el_res&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;el_res&#39;</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_el_res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="c1"># Extract electric resistance parameters</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_el_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_el_res&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_el_res&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;gas_burn&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;gas_burn&#39;</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_gas_burn</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="c1"># Extract gas burner parameters</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_gas_burn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comb_eff&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comb_eff&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># when adding components, extract parameters similarly</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_defaults</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># extract component size/capacity (see setter for details)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">sizes</span>

        <span class="c1"># extract weather and irradiation data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weather</span> <span class="o">=</span> <span class="n">weather</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">weather</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__weather</span>

    <span class="nd">@weather</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">weather</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Re-extracts weather timeseries if a new weather dataset</span>
<span class="sd">        is assigned to an instantiated class object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__weather</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_amb</span> <span class="o">=</span> <span class="n">UnitConv</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;t_amb_C&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">degC_K</span><span class="p">(</span><span class="n">unit_in</span><span class="o">=</span><span class="s1">&#39;degC&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weather</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;irrad_on_tilt&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Assigned weather data timeseries.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_amb</span> <span class="o">=</span> <span class="mf">293.15</span>  <span class="c1"># K</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span> <span class="o">=</span> <span class="mi">800</span>  <span class="c1"># W</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;No weather data got passed to converters. &#39;</span>\
                  <span class="s1">&#39;Setting default scalar values for ambient temperature, &#39;</span>\
                  <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">, and solar irradiation, </span><span class="si">{}</span><span class="s1">.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_amb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span>

    <span class="nd">@size</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Re-extracts sizes from a dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">set_sizes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mf">1.</span><span class="p">):</span>
            <span class="c1"># assign unit size</span>
            <span class="n">set_sizes</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;gas_tank&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">set_sizes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;gas_tank&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                <span class="n">value</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;gas_tank&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;sol_col&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">set_sizes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;sol_col&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                <span class="n">value</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;sol_col&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;pv&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">set_sizes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;pv&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                <span class="n">value</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;pv&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">set_sizes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                <span class="n">value</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;hp&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;el_res&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">set_sizes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;el_res&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                <span class="n">value</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;el_res&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;gas_burn&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">set_sizes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;gas_burn&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                    <span class="n">value</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;gas_burn&#39;</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">set_sizes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;gas_burn&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Could not find the size for the &#39;</span>\
                          <span class="s1">&#39;gas instantaneous water heater, &#39;</span>\
                          <span class="s1">&#39;Setting size to infinite.&#39;</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Provided sizes format is not supported.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">=</span> <span class="n">set_sizes</span>

<div class="viewcode-block" id="Converter.heat_pump"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Converter.heat_pump">[docs]</a>    <span class="k">def</span> <span class="nf">heat_pump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T_wet_bulb</span><span class="p">,</span> <span class="n">T_tank</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the current heating performance and electricity usage</span>
<span class="sd">        in the current conditions depending on wet bulb temperature,</span>
<span class="sd">        average tank water temperature, and the rated heating performance.</span>

<span class="sd">        Rated conditions are: wet bulb = 14 degC, tank = 48.9 degC</span>

<span class="sd">        Parameters:</span>

<span class="sd">            T_wet_bulb: real, array</span>
<span class="sd">                Inlet air wet bulb temperature [K]</span>

<span class="sd">            T_tank: real, array</span>
<span class="sd">                Water temperature in the storage tank [K]</span>

<span class="sd">            C1: real</span>
<span class="sd">                Coefficient 1, either for normalized COP or heating</span>
<span class="sd">                capacity curve [-]</span>

<span class="sd">            C2: real</span>
<span class="sd">                Coefficient 2, either for normalized COP or heating</span>
<span class="sd">                capacity curve [1/degC]</span>

<span class="sd">            C3: real</span>
<span class="sd">                Coefficient 3, either for normalized COP or heating</span>
<span class="sd">                capacity curve [1/degC2]</span>

<span class="sd">            C4: real</span>
<span class="sd">                Coefficient 4, either for normalized COP or heating</span>
<span class="sd">                capacity curve [1/degC]</span>

<span class="sd">            C5: real</span>
<span class="sd">                Coefficient 5, either for normalized COP or heating</span>
<span class="sd">                capacity curve [1/degC2]</span>

<span class="sd">            C6: real</span>
<span class="sd">                Coefficient 6, either for normalized COP or heating</span>
<span class="sd">                capacity curve [1/degC2]</span>

<span class="sd">        Returns:</span>

<span class="sd">            performance: dict</span>
<span class="sd">                {&#39;cop&#39;: current Coefficient Of Performance (COP) of</span>
<span class="sd">                heat pump, [-]</span>
<span class="sd">                 &#39;heat_cap&#39;: current heating capacity of heat pump, [W]</span>
<span class="sd">                 &#39;el_use&#39;: current electricity use of heat pump</span>
<span class="sd">                 (heat_cap / cop), [W]}</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Set rated heating capacity</span>
        <span class="n">heat_cap_rated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;heat_cap_rated&#39;</span><span class="p">]]</span>

        <span class="c1"># Set rated COP (coefficient of performance)</span>
        <span class="n">cop_rated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cop_rated&#39;</span><span class="p">]]</span>

        <span class="c1"># Calculate actual heating capacity under current conditions</span>
        <span class="c1"># (T_wet_bulb and T_tank)</span>
        <span class="n">heat_cap</span> <span class="o">=</span> <span class="n">heat_cap_rated</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heat_pump</span><span class="p">(</span>
            <span class="n">T_wet_bulb</span><span class="p">,</span>
            <span class="n">T_tank</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c1_heat_cap&#39;</span><span class="p">]],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c2_heat_cap&#39;</span><span class="p">]],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c3_heat_cap&#39;</span><span class="p">]],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c4_heat_cap&#39;</span><span class="p">]],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c5_heat_cap&#39;</span><span class="p">]],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c6_heat_cap&#39;</span><span class="p">]])</span>

        <span class="c1"># if the temperature difference between the tank and the</span>
        <span class="c1"># ambient is large (e.g. an outside tank in a cold climate)</span>
        <span class="c1"># negative heat_cap values may occur based on the</span>
        <span class="c1"># equation in _heat_pump. Assuming that the device is</span>
        <span class="c1"># disabled at those times, we impose a lower limit at 0:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">heat_cap</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">heat_cap</span><span class="p">[</span><span class="n">heat_cap</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">heat_cap</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">heat_cap</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">heat_cap</span> <span class="o">*</span> <span class="p">(</span><span class="n">heat_cap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># Calculate actual COP under current conditions</span>
        <span class="c1"># (T_wet_bulb and T_tank)</span>
        <span class="n">cop</span> <span class="o">=</span> <span class="n">cop_rated</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heat_pump</span><span class="p">(</span>
            <span class="n">T_wet_bulb</span><span class="p">,</span>
            <span class="n">T_tank</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c1_cop&#39;</span><span class="p">]],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c2_cop&#39;</span><span class="p">]],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c3_cop&#39;</span><span class="p">]],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c4_cop&#39;</span><span class="p">]],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c5_cop&#39;</span><span class="p">]],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params_hp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c6_cop&#39;</span><span class="p">]])</span>

        <span class="c1"># Dictionary containing the results</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;cop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cop</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;heat_cap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">heat_cap</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">heat_cap</span> <span class="o">/</span> <span class="n">cop</span>

        <span class="k">return</span> <span class="n">res</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_heat_pump</span><span class="p">(</span><span class="n">T_wet_bulb</span><span class="p">,</span> <span class="n">T_tank</span><span class="p">,</span> <span class="n">C1</span> <span class="o">=</span> <span class="mf">1.229E+00</span><span class="p">,</span>
                   <span class="n">C2</span> <span class="o">=</span> <span class="mf">5.549E-02</span><span class="p">,</span> <span class="n">C3</span> <span class="o">=</span> <span class="mf">1.139E-04</span><span class="p">,</span>
                   <span class="n">C4</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.128E-02</span><span class="p">,</span> <span class="n">C5</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.570E-06</span><span class="p">,</span>
                   <span class="n">C6</span> <span class="o">=</span> <span class="o">-</span><span class="mf">7.234E-04</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Heat pump model. Source:</span>
<span class="sd">        B. Sparn, K. Hudon, and D. Christensen, Laboratory Performance Evaluation of Residential Integrated Heat Pump Water Heaters, Renew. Energy, p. 77, 2014.</span>

<span class="sd">        https://www1.eere.energy.gov/buildings/publications/pdfs/building_america/evaluation_hpwh.pdf</span>

<span class="sd">        Parameters:</span>

<span class="sd">            T_wet_bulb: real, array</span>
<span class="sd">                Inlet air wet bulb temperature [K]</span>
<span class="sd">            T_tank: real, array</span>
<span class="sd">                Water temperature in the storage tank [K]</span>
<span class="sd">            C1: real</span>
<span class="sd">                Coefficient 1, either for normalized COP or heating capacity</span>
<span class="sd">                curve [-]</span>
<span class="sd">            C2: real</span>
<span class="sd">                Coefficient 2, either for normalized COP or heating capacity</span>
<span class="sd">                curve [1/degC]</span>
<span class="sd">            C3: real</span>
<span class="sd">                Coefficient 3, either for normalized COP or heating capacity</span>
<span class="sd">                curve [1/degC^2]</span>
<span class="sd">            C4: real</span>
<span class="sd">                Coefficient 4, either for normalized COP or heating capacity</span>
<span class="sd">                curve [1/deg^C]</span>
<span class="sd">            C5: real</span>
<span class="sd">                Coefficient 5, either for normalized COP or heating capacity</span>
<span class="sd">                curve [1/degC^2]</span>
<span class="sd">            C6: real</span>
<span class="sd">                Coefficient 6, either for normalized COP or heating capacity</span>
<span class="sd">                curve [1/degC^2]</span>

<span class="sd">        Returns:</span>

<span class="sd">            performance: real</span>
<span class="sd">                Performance factor</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># The formula needs temperatures in Celsius</span>
        <span class="n">T_wet_bulb_C</span> <span class="o">=</span> <span class="n">UnitConv</span><span class="p">(</span><span class="n">T_wet_bulb</span><span class="p">)</span><span class="o">.</span><span class="n">degC_K</span><span class="p">(</span><span class="n">unit_in</span><span class="o">=</span><span class="s1">&#39;K&#39;</span><span class="p">)</span>
        <span class="n">T_tank_C</span> <span class="o">=</span> <span class="n">UnitConv</span><span class="p">(</span><span class="n">T_tank</span><span class="p">)</span><span class="o">.</span><span class="n">degC_K</span><span class="p">(</span><span class="n">unit_in</span><span class="o">=</span><span class="s1">&#39;K&#39;</span><span class="p">)</span>

        <span class="c1"># Calculate performance factor</span>
        <span class="n">performance</span> <span class="o">=</span> <span class="p">(</span><span class="n">C1</span> <span class="o">+</span> <span class="n">C2</span> <span class="o">*</span> <span class="n">T_wet_bulb_C</span> <span class="o">+</span>
                       <span class="n">C3</span> <span class="o">*</span> <span class="n">T_wet_bulb_C</span> <span class="o">*</span> <span class="n">T_wet_bulb_C</span> <span class="o">+</span>
                       <span class="n">C4</span> <span class="o">*</span> <span class="n">T_tank_C</span> <span class="o">+</span> <span class="n">C5</span> <span class="o">*</span> <span class="n">T_tank_C</span> <span class="o">*</span> <span class="n">T_tank_C</span> <span class="o">+</span>
                       <span class="n">C6</span> <span class="o">*</span> <span class="n">T_wet_bulb_C</span> <span class="o">*</span> <span class="n">T_tank_C</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">performance</span>

<div class="viewcode-block" id="Converter.electric_resistance"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Converter.electric_resistance">[docs]</a>    <span class="k">def</span> <span class="nf">electric_resistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Q_dem</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Electric resistance heater model. Can be</span>
<span class="sd">        used both as an instantaneous electric WH and as</span>
<span class="sd">        an auxiliary heater within the thermal tank.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            Q_dem: float or array like, [W]</span>
<span class="sd">                Heat demand</span>

<span class="sd">        Returns:</span>

<span class="sd">            res: dict</span>
<span class="sd">                self.r[&#39;q_del_bckp&#39;] : float, array - delivered heat rate, [W]</span>
<span class="sd">                self.r[&#39;q_el_use&#39;] : float, array - electricity use, [W]</span>
<span class="sd">                self.r[&#39;q_unmet&#39;] : float, array - unmet demand heat rate, [W]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># return the heat rates for:</span>
        <span class="c1"># delivered heat, electricity use, and unmet demand</span>
        <span class="n">Q_del</span><span class="p">,</span> <span class="n">P_el_use</span><span class="p">,</span> <span class="n">Q_unmet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heater</span><span class="p">(</span>
            <span class="n">Q_dem</span><span class="p">,</span>
            <span class="n">Q_nom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;el_res&#39;</span><span class="p">]],</span>
            <span class="n">eff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_el_res</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_el_res&#39;</span><span class="p">]])</span>

        <span class="c1"># return the heat rate of heat delivered and gas consumed</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]:</span> <span class="n">Q_del</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;el_use&#39;</span><span class="p">]:</span> <span class="n">P_el_use</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]:</span> <span class="n">Q_unmet</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Converter.gas_burner"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Converter.gas_burner">[docs]</a>    <span class="k">def</span> <span class="nf">gas_burner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Q_dem</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gas burner model. Used both</span>
<span class="sd">        as an instantaneous gas WH and as a</span>
<span class="sd">        gas backup for solar thermal.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            Q_dem: float or array like, W</span>
<span class="sd">                Heat demand</span>

<span class="sd">        Returns:</span>

<span class="sd">            res: dict</span>
<span class="sd">                self.r[&#39;q_del_bckp&#39;] : float, array - delivered heat rate, [W]</span>
<span class="sd">                self.r[&#39;q_gas_use&#39;] : float, array - gas use heat rate, [W]</span>
<span class="sd">                self.r[&#39;q_unmet&#39;] : float, array - unmet demand heat rate, [W]</span>

<span class="sd">                Any further unit conversion should be performed</span>
<span class="sd">                using unit_converters.Utility class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># return the heat rates for:</span>
        <span class="c1"># delivered heat, gas use, and unmet demand</span>
        <span class="n">Q_del</span><span class="p">,</span> <span class="n">Q_en_use</span><span class="p">,</span> <span class="n">Q_unmet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_heater</span><span class="p">(</span>
            <span class="n">Q_dem</span><span class="p">,</span>
            <span class="n">eff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_gas_burn</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comb_eff&#39;</span><span class="p">]],</span>
            <span class="n">Q_nom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;gas_burn&#39;</span><span class="p">]])</span>

        <span class="c1"># return the heat rate of heat delivered and gas consumed</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_bckp&#39;</span><span class="p">]:</span> <span class="n">Q_del</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]:</span> <span class="n">Q_en_use</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet&#39;</span><span class="p">]:</span> <span class="n">Q_unmet</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">res</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_heater</span><span class="p">(</span><span class="n">Q_dem</span><span class="p">,</span> <span class="n">eff</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span> <span class="n">Q_nom</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simplified efficiency based model that can be</span>
<span class="sd">        used for an in-tank main or auxiliary gas and</span>
<span class="sd">        electric resistance heater.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            Q_dem: float or array like, W</span>
<span class="sd">                Heat demand</span>

<span class="sd">            eff: float</span>
<span class="sd">                Energy conversion efficiency, such as</span>
<span class="sd">                combustion or electric resistance</span>

<span class="sd">            Q_nom: float, W</span>
<span class="sd">                Nominal capacity.</span>
<span class="sd">                Default: None - infinite capacity</span>
<span class="sd">                so that the heater can cover any load</span>

<span class="sd">        Returns:</span>

<span class="sd">            Q_del: float, array</span>
<span class="sd">                Delivered heat rate, [W]</span>
<span class="sd">            Q_gas_use: float, array</span>
<span class="sd">                Energy (gas, electricity) use heat rate, [W]</span>
<span class="sd">            Q_unmet: float, array</span>
<span class="sd">                Unmet demand heat rate, [W]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># start with assuming the heater capacity is infinite</span>
        <span class="n">Q_del</span> <span class="o">=</span> <span class="n">Q_dem</span> <span class="o">+</span> <span class="mf">0.</span>

        <span class="c1"># limit the delivery if the heater has a limited capacity</span>
        <span class="k">if</span> <span class="n">Q_nom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">Q_dem</span><span class="p">):</span>
                <span class="n">Q_del</span><span class="p">[</span><span class="n">Q_del</span> <span class="o">&gt;</span> <span class="n">Q_nom</span><span class="p">]</span> <span class="o">=</span> <span class="n">Q_nom</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">Q_dem</span><span class="p">):</span>
                <span class="n">Q_del</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">Q_dem</span><span class="p">,</span> <span class="n">Q_nom</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Heater demand data type </span><span class="si">{}</span><span class="s1"> seems not supported.&#39;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">Q_dem</span><span class="p">)))</span>
                <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1"># Unmet demand</span>
        <span class="n">Q_unmet</span> <span class="o">=</span> <span class="n">Q_dem</span> <span class="o">-</span> <span class="n">Q_del</span>

        <span class="c1"># Gas consumption (heat rate in W, use unit_converters.Utility class</span>
        <span class="c1"># for further conversions)</span>
        <span class="n">Q_en_use</span> <span class="o">=</span> <span class="n">Q_del</span> <span class="o">/</span> <span class="n">eff</span>

        <span class="k">return</span> <span class="n">Q_del</span><span class="p">,</span> <span class="n">Q_en_use</span><span class="p">,</span> <span class="n">Q_unmet</span>

<div class="viewcode-block" id="Converter.solar_collector"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Converter.solar_collector">[docs]</a>    <span class="k">def</span> <span class="nf">solar_collector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_in</span><span class="p">,</span> <span class="n">t_amb</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inc_rad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Two commonly used empirical instantaneous collector</span>
<span class="sd">        efficiency models based on test data from standard</span>
<span class="sd">        test procedures (SRCC, ISO9806), found in</span>
<span class="sd">        J. A. Duffie and W. A. Beckman, Solar engineering of thermal processes, 3rd ed. Hoboken, N.J: Wiley, 2006., are:</span>

<span class="sd">        * Cooper and Dunkle (CD model, eq 6.17.7)</span>
<span class="sd">        * Hottel-Whillier-Bliss (HWB model, eq 6.16.1, 6.7.6)</span>

<span class="sd">        Parameters:</span>

<span class="sd">            t_in: float, array</span>
<span class="sd">                Collector inlet temperature (timeseries) [K]</span>

<span class="sd">            t_amb: float, array</span>
<span class="sd">                Ambient temperature (timeseries) [K]</span>
<span class="sd">                Default: None (to use data extracted from the weather df)</span>

<span class="sd">            inc_rad: float, array</span>
<span class="sd">                Incident radiation (timeseries) [W]</span>
<span class="sd">                Default: None (to use data extracted from the weather df)</span>

<span class="sd">        Returns:</span>

<span class="sd">            res: dict or floats or arrays</span>

<span class="sd">                {&#39;Q_gain&#39; : Solar gains from the gross collector area, [W]</span>
<span class="sd">                 &#39;eff&#39; : Efficiency of solar to heat conversion, [-]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gross_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;sol_col&#39;</span><span class="p">]]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">gross_area</span> <span class="o">=</span> <span class="mf">1.</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Could not extract collector size. &#39;</span>\
                  <span class="s1">&#39;Setting it to </span><span class="si">{}</span><span class="s1">.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gross_area</span><span class="p">))</span>

        <span class="c1"># if t_in is output of the tank model, solar collector</span>
        <span class="c1"># model needs to be simulated step by step. In that</span>
        <span class="c1"># case the timestep ambient temperature and incident solar</span>
        <span class="c1"># radiation should be passed directly to this method</span>
        <span class="k">if</span> <span class="n">t_amb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Using ambient temperature array to get solar &#39;</span>\
                <span class="s1">&#39;collector gains. This will result in an array calculation.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">t_amb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_amb</span>

        <span class="k">if</span> <span class="n">inc_rad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Using irradiation array to get solar collector&#39;</span>\
                  <span class="s1">&#39; gains. This will result in an array calculation.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">inc_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_defaults</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Solar collector parameters have not been passed to the&#39;</span>\
                  <span class="s1">&#39; component model. Using HWB model with default parameters.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sol_col_gain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol_col_eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hwb_solar_collector</span><span class="p">(</span>
                <span class="n">gross_area</span><span class="p">,</span>
                <span class="n">inc_rad</span><span class="p">,</span>
                <span class="n">t_amb</span><span class="p">,</span>
                <span class="n">t_in</span><span class="p">)</span>

        <span class="c1"># based on the keywords in self.params call one or the other method</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_model</span> <span class="o">==</span> <span class="s1">&#39;HWB&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sol_col_gain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol_col_eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hwb_solar_collector</span><span class="p">(</span>
                <span class="n">gross_area</span><span class="p">,</span>
                <span class="n">inc_rad</span><span class="p">,</span>
                <span class="n">t_amb</span><span class="p">,</span>
                <span class="n">t_in</span><span class="p">,</span>
                <span class="n">intercept</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_sol_col</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;interc_hwb&#39;</span><span class="p">]],</span>
                <span class="n">slope</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_sol_col</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;slope_hwb&#39;</span><span class="p">]])</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_model</span> <span class="o">==</span> <span class="s1">&#39;CD&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sol_col_gain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol_col_eff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cd_solar_collector</span><span class="p">(</span>
                <span class="n">gross_area</span><span class="p">,</span>
                <span class="n">inc_rad</span><span class="p">,</span>
                <span class="n">t_amb</span><span class="p">,</span>
                <span class="n">t_in</span><span class="p">,</span>
                <span class="n">intercept</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_sol_col</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;interc_cd&#39;</span><span class="p">]],</span>
                <span class="n">a_1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_sol_col</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;a1_cd&#39;</span><span class="p">]],</span>
                <span class="n">a_2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_sol_col</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;a2_cd&#39;</span><span class="p">]])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t_in</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Calculated solar collector gain time series.</span><span class="se">\n</span><span class="s1">&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Q_gain&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol_col_gain</span><span class="p">,</span>\
               <span class="s1">&#39;eff&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol_col_eff</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">res</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_hwb_solar_collector</span><span class="p">(</span><span class="n">gross_area</span><span class="p">,</span> <span class="n">inc_rad</span><span class="p">,</span> <span class="n">t_amb</span><span class="p">,</span> <span class="n">t_in</span><span class="p">,</span>
                             <span class="n">intercept</span><span class="o">=.</span><span class="mi">753</span><span class="p">,</span> <span class="n">slope</span><span class="o">=-</span><span class="mf">4.025</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;HWB based model as applied in test procedures</span>
<span class="sd">        used in SRCC Standard 100-2006-09 (ASHRAE 93)</span>

<span class="sd">        Default parameters: Heliodyne, Inc, GOBI 410 001 Plus</span>

<span class="sd">        Parameters:</span>

<span class="sd">            gross_area: float</span>
<span class="sd">                Gross collector area [m2]</span>

<span class="sd">            inc_rad: float or array like</span>
<span class="sd">                Global solar radiation on 1 m2 of the</span>
<span class="sd">                collector tilted surface [W/m2]</span>

<span class="sd">            t_amb: float or array like</span>
<span class="sd">                Ambient temperature (timeseries) [K or degC]</span>

<span class="sd">            t_in: float or array like</span>
<span class="sd">                Collector inlet temperature (timeseries)</span>
<span class="sd">                [use same unit as t_amb]</span>

<span class="sd">            intercept: float</span>
<span class="sd">                Rating parameter</span>

<span class="sd">            slope: float</span>
<span class="sd">                Rating parameter</span>

<span class="sd">        Returns:</span>

<span class="sd">            solar_gain: float, array</span>
<span class="sd">                Solar gains from the gross collector area [W]</span>

<span class="sd">            conversion_efficiency: float, array</span>
<span class="sd">                Conversion efficiency [-]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># msg = &#39;Allow div 0.&#39;</span>
        <span class="c1"># log.debug(msg)</span>

        <span class="c1"># avoid division by zero by creating a copy</span>
        <span class="c1"># of the irradiation data with infinity</span>
        <span class="c1"># instead of zero (see efficiency formula)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">inc_rad</span><span class="p">):</span>
            <span class="n">inc_rad_mod</span> <span class="o">=</span> <span class="n">inc_rad</span>
            <span class="n">inc_rad_mod</span><span class="p">[</span><span class="n">inc_rad</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">inc_rad</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">inc_rad</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">inc_rad_mod</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inc_rad_mod</span> <span class="o">=</span> <span class="n">inc_rad</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Solar irradiation data type </span><span class="si">{}</span><span class="s1"> seems not supported.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">Q_dem</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1"># instantaneous collector efficiency, [-]</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="p">(</span><span class="n">intercept</span> <span class="o">*</span> <span class="p">(</span><span class="n">inc_rad</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">+</span>
               <span class="n">slope</span> <span class="o">*</span> <span class="p">((</span><span class="n">t_in</span> <span class="o">-</span> <span class="n">t_amb</span><span class="p">)</span> <span class="o">/</span> <span class="n">inc_rad_mod</span><span class="p">))</span>

        <span class="c1"># instantaneous solar gain, [W]</span>
        <span class="n">calc_gain</span> <span class="o">=</span>  <span class="n">inc_rad</span> <span class="o">*</span> <span class="n">gross_area</span> <span class="o">*</span> <span class="n">eta</span>

        <span class="c1"># set negative gains that the model may yield at</span>
        <span class="c1"># cold weather to zero</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">calc_gain</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">calc_gain</span><span class="p">[</span><span class="n">calc_gain</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="n">calc_gain</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">calc_gain</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="n">calc_gain</span> <span class="o">*</span> <span class="p">(</span><span class="n">calc_gain</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gain</span><span class="p">,</span> <span class="n">eta</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_cd_solar_collector</span><span class="p">(</span><span class="n">gross_area</span><span class="p">,</span> <span class="n">inc_rad</span><span class="p">,</span> <span class="n">t_amb</span><span class="p">,</span> <span class="n">t_in</span><span class="p">,</span>
                            <span class="n">intercept</span><span class="o">=.</span><span class="mi">75</span><span class="p">,</span> <span class="n">a_1</span><span class="o">=-</span><span class="mf">3.688</span><span class="p">,</span> <span class="n">a_2</span><span class="o">=-.</span><span class="mi">0055</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;CD based model as applied in test procedures</span>
<span class="sd">        used in SRCC Standard 100-2006-09 (ISO 12975 with dT = Tin - Tamb)</span>

<span class="sd">        Default parameters: `Heliodyne, Inc, GOBI 410 001 Plus &lt;https://secure.solar-rating.org/Certification/Ratings/RatingsReport.aspx?device=6931&amp;units=METRICS&gt;`_</span>

<span class="sd">        Parameters:</span>

<span class="sd">            gross_area: float</span>
<span class="sd">                Gross collector area [m2]</span>

<span class="sd">            inc_rad: float, array</span>
<span class="sd">                Global solar radiation on 1 m2 of the</span>
<span class="sd">                collector tilted surface [W/m2]</span>

<span class="sd">            t_amb: float, array</span>
<span class="sd">                Ambient temperature (timeseries) [K or degC]</span>

<span class="sd">            t_in: float, array</span>
<span class="sd">                Collector inlet temperature (timeseries)</span>
<span class="sd">                [use same unit as t_amb]</span>

<span class="sd">            intercept: float</span>
<span class="sd">                Rating parameter</span>

<span class="sd">            a_1: float</span>
<span class="sd">                Rating parameter</span>

<span class="sd">            a_2: float</span>
<span class="sd">                Rating parameter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># avoid division by zero by creating a copy</span>
        <span class="c1"># of the irradiation data with infinity</span>
        <span class="c1"># instead of zero (see efficiency formula)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">inc_rad</span><span class="p">):</span>
            <span class="n">inc_rad_mod</span> <span class="o">=</span> <span class="n">inc_rad</span>
            <span class="n">inc_rad_mod</span><span class="p">[</span><span class="n">inc_rad</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">inc_rad</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">inc_rad</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">inc_rad_mod</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">inc_rad_mod</span> <span class="o">=</span> <span class="n">inc_rad</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Solar irradiation data type </span><span class="si">{}</span><span class="s1"> seems not supported.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">Q_dem</span><span class="p">)))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

        <span class="c1"># instantaneous collector efficiency, [-]</span>
        <span class="n">eta</span> <span class="o">=</span> <span class="p">(</span><span class="n">intercept</span> <span class="o">*</span> <span class="p">(</span><span class="n">inc_rad</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">+</span>
               <span class="n">a_1</span> <span class="o">*</span> <span class="p">((</span><span class="n">t_in</span> <span class="o">-</span> <span class="n">t_amb</span><span class="p">)</span> <span class="o">/</span> <span class="n">inc_rad_mod</span><span class="p">)</span> <span class="o">+</span>
               <span class="n">a_2</span> <span class="o">*</span> <span class="p">((</span><span class="n">t_in</span> <span class="o">-</span> <span class="n">t_amb</span><span class="p">)</span> <span class="o">/</span> <span class="n">inc_rad_mod</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>

        <span class="c1"># instantaneous solar gain, [W]</span>
        <span class="n">calc_gain</span> <span class="o">=</span> <span class="n">inc_rad</span> <span class="o">*</span> <span class="n">gross_area</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">eta</span><span class="p">)</span>

        <span class="c1"># set negative gains that the model may yield at</span>
        <span class="c1"># cold weather to zero</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">calc_gain</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">calc_gain</span><span class="p">[</span><span class="n">calc_gain</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="n">calc_gain</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">calc_gain</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="n">calc_gain</span> <span class="o">*</span> <span class="p">(</span><span class="n">calc_gain</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gain</span><span class="p">,</span> <span class="n">eta</span>

<div class="viewcode-block" id="Converter.photovoltaic"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Converter.photovoltaic">[docs]</a>    <span class="k">def</span> <span class="nf">photovoltaic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">use_p_peak</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inc_rad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Photovoltaic model</span>

<span class="sd">        Parameters:</span>

<span class="sd">            use_p_peak: boolean</span>
<span class="sd">                Boolean flag determining if peak power is used for sizing</span>
<span class="sd">                the pv panel (instead of area and efficiency)</span>

<span class="sd">        Returns:</span>

<span class="sd">            self.pv_power: dict of floats</span>
<span class="sd">                Generated power [W]</span>
<span class="sd">                &#39;ac&#39; : AC</span>
<span class="sd">                &#39;dc&#39; : DC</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">panel_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;pv&#39;</span><span class="p">]]</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># default to 1000. kW_peak or it&#39;s equivalent in m2 for</span>
            <span class="c1"># default efficiency</span>
            <span class="n">panel_size</span> <span class="o">=</span> <span class="mf">1000.</span> <span class="k">if</span> <span class="n">use_p_peak</span> <span class="k">else</span> <span class="mf">6.25</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>\
                <span class="s1">&#39;Could not get panel size. Setting it to </span><span class="si">{}</span><span class="s1">&#39;</span>\
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">panel_size</span><span class="p">))</span>

        <span class="c1"># Set panel size according to use_p_peak value</span>
        <span class="k">if</span> <span class="n">use_p_peak</span><span class="p">:</span>
            <span class="n">p_peak</span> <span class="o">=</span> <span class="n">panel_size</span>
            <span class="n">panel_area</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Uncomment this line, since it creates too much output</span>
            <span class="c1"># for system level simulation</span>
            <span class="c1"># log.info(&#39;Using peak power as a PV size parameter.&#39;)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_peak</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">panel_area</span> <span class="o">=</span> <span class="n">panel_size</span>
            <span class="c1"># Uncomment this line, since it creates too much output</span>
            <span class="c1"># for system level simulation</span>
            <span class="c1">#log.info(&#39;Using area as a PV size parameter.&#39;)</span>

        <span class="k">if</span> <span class="n">inc_rad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Using irradiation array to get photovoltaic&#39;</span>\
                  <span class="s1">&#39; gains. This will result in an array calculation.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">inc_rad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inc_rad</span>

        <span class="c1"># if no input parameters have been passed to the class</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_defaults</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Photovoltaic parameters have not been passed to the&#39;</span>\
                  <span class="s1">&#39; component model. Using default parameters.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pv_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_photovoltaic</span><span class="p">(</span>
                <span class="n">irrad</span><span class="o">=</span><span class="n">inc_rad</span><span class="p">,</span>
                <span class="n">panel_area</span><span class="o">=</span><span class="n">panel_area</span><span class="p">,</span>
                <span class="n">p_peak</span><span class="o">=</span><span class="n">p_peak</span><span class="p">)</span>

        <span class="c1"># pass parameters from the param input dataframe</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pv_power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simple_photovoltaic</span><span class="p">(</span>
                <span class="n">irrad</span><span class="o">=</span><span class="n">inc_rad</span><span class="p">,</span>
                <span class="n">panel_area</span><span class="o">=</span><span class="n">panel_area</span><span class="p">,</span>
                <span class="n">f_act</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_pv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;f_act&#39;</span><span class="p">]],</span>
                <span class="n">eta_pv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_pv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_pv&#39;</span><span class="p">]],</span>
                <span class="n">eta_dc_ac</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_inv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_dc_ac&#39;</span><span class="p">]],</span>
                <span class="n">irrad_ref</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_pv</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;irrad_ref&#39;</span><span class="p">]],</span>
                <span class="n">p_peak</span><span class="o">=</span><span class="n">p_peak</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">pv_power</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_simple_photovoltaic</span><span class="p">(</span><span class="n">irrad</span><span class="p">,</span> <span class="n">p_peak</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">panel_area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">f_act</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">eta_pv</span><span class="o">=.</span><span class="mi">16</span><span class="p">,</span>
                             <span class="n">eta_dc_ac</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span> <span class="n">irrad_ref</span><span class="o">=</span><span class="mf">1000.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simple photovoltaic model based on</span>
<span class="sd">        http://simulationresearch.lbl.gov/modelica/releases/latest/help/Buildings_Electrical_AC_OnePhase_Sources.html#Buildings.Electrical.AC.OnePhase.Sources.PVSimple</span>

<span class="sd">        Parameters:</span>

<span class="sd">            irrad: float</span>
<span class="sd">                Total solar irradiation (direct and diffuse) [W/m2]</span>

<span class="sd">            panel_area: float or None</span>
<span class="sd">                Panel area (area of active cells) [m2].</span>
<span class="sd">                Set to None if using the peak power as a PV sizing variable.</span>

<span class="sd">            p_peak: float or None</span>
<span class="sd">                Peak power of the photovoltaic panel</span>
<span class="sd">                (also: nominal power, nameplate size) [W]</span>
<span class="sd">                Set to None if using the panel area as a PV sizing variable.</span>

<span class="sd">            irrad_ref: float</span>
<span class="sd">                Reference irradiation of the photovoltaic panel</span>
<span class="sd">                (default: 1000 W/m2) [W/m2]</span>

<span class="sd">            f_act: float</span>
<span class="sd">                Fraction of the aperature panel with active cells</span>

<span class="sd">            eta_pv: float</span>
<span class="sd">                Panel efficiency</span>

<span class="sd">            eta_dc_ac: float</span>
<span class="sd">                Efficiency of the dc-ac conversion</span>
<span class="sd">                (inverter + other system losses)</span>

<span class="sd">        Returns:</span>

<span class="sd">            pv_power: dict of floats</span>
<span class="sd">                Generated power [W]</span>
<span class="sd">                &#39;ac&#39; : AC</span>
<span class="sd">                &#39;dc&#39; : DC</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate the generated power according to the given parameters:</span>
        <span class="c1"># Either panel area and panel efficiency</span>
        <span class="c1"># or peak power and reference irradiation are used for calculation</span>
        <span class="k">if</span> <span class="n">p_peak</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pv_power_dc</span> <span class="o">=</span> <span class="n">panel_area</span> <span class="o">*</span> <span class="n">f_act</span> <span class="o">*</span> <span class="n">eta_pv</span> <span class="o">*</span> <span class="n">irrad</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pv_power_dc</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_peak</span> <span class="o">/</span> <span class="n">irrad_ref</span><span class="p">)</span> <span class="o">*</span> <span class="n">irrad</span>

        <span class="n">pv_power_ac</span> <span class="o">=</span> <span class="n">Distribution</span><span class="o">.</span><span class="n">_dc_to_ac</span><span class="p">(</span>
            <span class="n">pv_power_dc</span><span class="p">,</span>
            <span class="n">conv_eff</span><span class="o">=</span><span class="n">eta_dc_ac</span><span class="p">)</span>

        <span class="n">pv_power</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ac&#39;</span><span class="p">:</span> <span class="n">pv_power_ac</span><span class="p">,</span>
                    <span class="s1">&#39;dc&#39;</span><span class="p">:</span> <span class="n">pv_power_dc</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">pv_power</span></div>


<div class="viewcode-block" id="Storage"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Storage">[docs]</a><span class="k">class</span> <span class="nc">Storage</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes performance of storage components, such as</span>
<span class="sd">    solar thermal tank, heat pump thermal tank, conventional gas</span>
<span class="sd">    tank water heater.</span>

<span class="sd">    Parameters:</span>

<span class="sd">        params: pd df</span>
<span class="sd">            Component performance parameters per project</span>
<span class="sd">            Default: None. See tests and examples on how to</span>
<span class="sd">            structure this input.</span>

<span class="sd">        weather: pd df</span>
<span class="sd">            Weather data timeseeries (amb. temp, solar irradiation)</span>
<span class="sd">            Default: None. See tests and examples on how to</span>
<span class="sd">            structure this input.</span>

<span class="sd">        size: pd df or float, m3</span>
<span class="sd">            Tank size.</span>
<span class="sd">            Default 1. See tests and examples on how to</span>
<span class="sd">            structure this input.</span>

<span class="sd">        type: string</span>
<span class="sd">            Type of storage component. Options:</span>
<span class="sd">            &#39;sol_tank&#39; - indirect tank WH with a coil to circulate</span>
<span class="sd">            fluid heated by a solar collector</span>
<span class="sd">            &#39;hp_tank&#39; - tank with an inbuilt heat pump</span>
<span class="sd">            &#39;wham_tank&#39; - conventional gas tank water heater model</span>
<span class="sd">            based on a WH model from the efficiency standards analysis</span>
<span class="sd">            &#39;gas_tank&#39; - conventional gas tank water heater (*mg not</span>
<span class="sd">            implemented)</span>

<span class="sd">        log_level: None or python logger logging level,</span>
<span class="sd">            Default: logging.DEBUG</span>
<span class="sd">            This applies for a subset of the class functionality, mostly</span>
<span class="sd">            used to deprecate logger messages for certain calculations.</span>
<span class="sd">            For Example: log_level = logging.ERROR will only throw error</span>
<span class="sd">            messages and ignore INFO, DEBUG and WARNING.</span>

<span class="sd">        timestep: float, h</span>
<span class="sd">            Duration of a single timestep, in hours, defaults to 1.</span>

<span class="sd">    Note:</span>

<span class="sd">        Create a new instance of the class for each storage component.</span>

<span class="sd">    Examples:</span>

<span class="sd">        See ```swh.system.tests.test_components``` module and</span>
<span class="sd">        ```scripts/Project Level SWH System Tool.ipynb```</span>
<span class="sd">        for examples on how to use the methods as stand alone and</span>
<span class="sd">        in a system model simulation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;sol_tank&#39;</span><span class="p">,</span>
                 <span class="n">timestep</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>

        <span class="c1"># log level (e.g. only partial functionality of the class</span>
        <span class="c1"># is being used and one does not desire to see all infos)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="n">log_level</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">SwhLabels</span><span class="p">()</span><span class="o">.</span><span class="n">set_prod_labels</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">SwhLabels</span><span class="p">()</span><span class="o">.</span><span class="n">set_res_labels</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>

        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># extract component size/capacity (see setter for details)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>
            <span class="c1"># instantiate with defaut parameters</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sol_tank&#39;</span><span class="p">,</span> <span class="s1">&#39;hp_tank&#39;</span><span class="p">]:</span>
                <span class="n">split_tank</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">gas_heater_autosize</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;wham_tank&#39;</span><span class="p">:</span>
                <span class="n">split_tank</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">gas_heater_autosize</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;The thermal storage tank type </span><span class="si">{}</span><span class="s1">&#39;</span>\
                      <span class="s1">&#39;is not implemented.&#39;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">mgs</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">setup_thermal</span><span class="p">(</span>
                <span class="n">split_tank</span><span class="o">=</span><span class="n">split_tank</span><span class="p">,</span>
                <span class="n">gas_heater_autosize</span><span class="o">=</span><span class="n">gas_heater_autosize</span><span class="p">)</span>

            <span class="c1"># on the hp branch</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_electric</span><span class="p">()</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Storage parameters have not been passed to the class. &#39;</span>\
                  <span class="s1">&#39;Using default parameters.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">=</span> <span class="n">timestep</span>  <span class="c1"># [h]</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">components</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># get all components of the project level system</span>
            <span class="n">components</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;the_sto&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;the_sto&#39;</span><span class="p">])</span>

                <span class="n">comp_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;the_sto&#39;</span><span class="p">],:]</span>

                <span class="n">params_sol_tank</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;ins_thi&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                     <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;ins_thi&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;spec_hea_con&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;spec_hea_con&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;f_upper_vol&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;f_upper_vol&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;h_vs_r&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;h_vs_r&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dt_appr&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dt_appr&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;t_max_tank&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;t_max_tank&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;t_tap_set&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;t_tap_set&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;sol_tank&#39;</span><span class="p">:</span>
                    <span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_coil&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_coil&#39;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;hp_tank&#39;</span><span class="p">:</span>
                    <span class="c1"># based on the model definition (net performance of</span>
                    <span class="c1"># an inbuilt heat pump)</span>
                    <span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_coil&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;The thermal storage tank type </span><span class="si">{}</span><span class="s1">&#39;</span>\
                          <span class="s1">&#39;is not implemented.&#39;</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">mgs</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>
                    <span class="k">raise</span> <span class="ne">Exception</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>

                <span class="c1"># setup the solar storage tank with the given parameters</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setup_thermal</span><span class="p">(</span>
                    <span class="n">vol_fra_upper</span><span class="o">=</span><span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;f_upper_vol&#39;</span><span class="p">]],</span>
                    <span class="n">h_vs_r</span><span class="o">=</span><span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;h_vs_r&#39;</span><span class="p">]],</span>
                    <span class="n">dT_param</span><span class="o">=</span><span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dt_appr&#39;</span><span class="p">]],</span>
                    <span class="n">T_max</span><span class="o">=</span><span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;t_max_tank&#39;</span><span class="p">]],</span>
                    <span class="n">T_draw_set</span><span class="o">=</span><span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;t_tap_set&#39;</span><span class="p">]],</span>
                    <span class="n">insul_thickness</span><span class="o">=</span><span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;ins_thi&#39;</span><span class="p">]],</span>
                    <span class="n">spec_hea_cond</span><span class="o">=</span><span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;spec_hea_con&#39;</span><span class="p">]],</span>
                    <span class="n">coil_eff</span><span class="o">=</span><span class="n">params_sol_tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_coil&#39;</span><span class="p">]],</span>
                    <span class="n">gas_heater_autosize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> is set.&#39;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">])</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()))</span>

            <span class="k">elif</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;gas_tank&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">components</span><span class="p">)</span> <span class="ow">and</span>
                  <span class="p">(</span><span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;wham_tank&#39;</span><span class="p">)):</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;gas_tank&#39;</span><span class="p">])</span>

                <span class="n">comp_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;gas_tank&#39;</span><span class="p">],:]</span>

                <span class="n">params_gas_tank_wh</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="n">params_gas_tank_wh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;tank_re&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">comp_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;tank_re&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">params_gas_tank_wh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;ins_thi&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">comp_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;ins_thi&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">params_gas_tank_wh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;spec_hea_con&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">comp_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;spec_hea_con&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">params_gas_tank_wh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;t_tap_set&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">comp_params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;t_tap_set&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span>

                <span class="c1"># setup the gas tank water heater with the given parameters</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">setup_thermal</span><span class="p">(</span>
                    <span class="n">split_tank</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">T_draw_set</span><span class="o">=</span><span class="n">params_gas_tank_wh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;t_tap_set&#39;</span><span class="p">]],</span>
                    <span class="n">insul_thickness</span><span class="o">=</span><span class="n">params_gas_tank_wh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;ins_thi&#39;</span><span class="p">]],</span>
                    <span class="n">spec_hea_cond</span><span class="o">=</span><span class="n">params_gas_tank_wh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;spec_hea_con&#39;</span><span class="p">]],</span>
                    <span class="n">tank_re</span><span class="o">=</span><span class="n">params_gas_tank_wh</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;tank_re&#39;</span><span class="p">]],</span>
                    <span class="n">gas_heater_autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Gas tank WH (WHAM) is set up.&#39;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Parameters passed to the class do not contain the &#39;</span>\
                      <span class="s1">&#39;desired storage type </span><span class="si">{}</span><span class="s1">.&#39;</span>

                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">dist_sizes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="p">[[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;piping&#39;</span><span class="p">],</span> <span class="mf">0.</span><span class="p">]],</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span> <span class="o">=</span> <span class="n">Distribution</span><span class="p">(</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">sizes</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span>

    <span class="nd">@size</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Re-extracts tank size from a dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">set_size</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="c1"># assign unit size</span>
            <span class="n">set_size</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;the_sto&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">set_size</span> <span class="o">=</span> \
                <span class="n">value</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;the_sto&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;gas_tank&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">set_size</span> <span class="o">=</span> \
                <span class="n">value</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;gas_tank&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;hp_tank&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">set_size</span> <span class="o">=</span> \
                <span class="n">value</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;hp_tank&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Provided sizes format is not supported.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">=</span> <span class="n">set_size</span>

<div class="viewcode-block" id="Storage.setup_thermal"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Storage.setup_thermal">[docs]</a>    <span class="k">def</span> <span class="nf">setup_thermal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">medium</span><span class="o">=</span><span class="s1">&#39;water&#39;</span><span class="p">,</span>
                      <span class="n">split_tank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">vol_fra_upper</span><span class="o">=.</span><span class="mi">5</span><span class="p">,</span> <span class="n">h_vs_r</span><span class="o">=</span><span class="mf">6.</span><span class="p">,</span>
                      <span class="n">dT_param</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span>
                      <span class="n">T_max</span><span class="o">=</span><span class="mf">344.15</span><span class="p">,</span> <span class="n">T_draw_set</span><span class="o">=</span><span class="mf">322.04</span><span class="p">,</span>
                      <span class="n">insul_thickness</span><span class="o">=.</span><span class="mi">085</span><span class="p">,</span>
                      <span class="n">spec_hea_cond</span><span class="o">=.</span><span class="mi">04</span><span class="p">,</span>
                      <span class="n">coil_eff</span><span class="o">=.</span><span class="mi">84</span><span class="p">,</span>
                      <span class="n">tank_re</span><span class="o">=.</span><span class="mi">76</span><span class="p">,</span>
                      <span class="n">dT_err_max</span><span class="o">=</span><span class="mf">2.</span><span class="p">,</span>
                      <span class="n">gas_heater_autosize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets thermal storage variables related to:</span>

<span class="sd">        - loss calculation</span>
<span class="sd">        - distribution of net gains/losses within two</span>
<span class="sd">          tank volumes (upper and lower)</span>

<span class="sd">        Parameters:</span>

<span class="sd">            medimum: string</span>
<span class="sd">                Storing medium (for thermal defaults to &#39;water&#39;)</span>

<span class="sd">            vol_fra_upper: float</span>
<span class="sd">                Fraction of storage volume assigned to the upper</span>
<span class="sd">                tank volume (applies to &#39;thermal&#39; only)</span>
<span class="sd">                If split_tank set to False, the value is ignored</span>

<span class="sd">            dT_param: float, K</span>
<span class="sd">                Used as:</span>

<span class="sd">                * Maximum temperature difference expected to occur</span>
<span class="sd">                between the upper and the lower tank volume while charging</span>

<span class="sd">                * In-tank-coil approach</span>

<span class="sd">            h_vs_r: float</span>
<span class="sd">                Regression parameter - tank height/diameter ratio</span>
<span class="sd">                (based on web scraped data, see</span>
<span class="sd">                `scripts/Gallons vs. Height` notebook), default: 6.</span>

<span class="sd">            T_max: float, K</span>
<span class="sd">                Maximum allowed fluid temperature in the thermal</span>
<span class="sd">                storage tank, defaults to 344.15 K = 71 degC.</span>

<span class="sd">            T_draw_set: float, K</span>
<span class="sd">                Draw temperature used in the</span>
<span class="sd">                load calculation, defaults to</span>
<span class="sd">                120 degF = 322.04 K = 48.89 degC</span>

<span class="sd">            coil_eff: float</span>
<span class="sd">                Simplified efficiency of the coil heat exchanger</span>
<span class="sd">                Used in modeling of indirect coil-in-tank water heaters</span>
<span class="sd">                It excludes the approach temperature and represents</span>
<span class="sd">                the remaining heat transfer inefficiency</span>

<span class="sd">            tank_re: float</span>
<span class="sd">                Recovery efficiency of a gas tank water heater.</span>
<span class="sd">                Used for the Storage.gas_tank_wh model</span>

<span class="sd">            dT_err_max: float</span>
<span class="sd">                Allowed dT error below the minimum</span>
<span class="sd">                tank temperature due to finite timestep length</span>
<span class="sd">                approximation</span>

<span class="sd">            gas_heater_autosize: boolean</span>
<span class="sd">                There is a gas heater in the tank and it will be</span>
<span class="sd">                autosized based on the tank volume</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># max allowed tank temperature (start with 160 degF, per TAC info)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_max</span> <span class="o">=</span> <span class="n">T_max</span>  <span class="c1"># K</span>

        <span class="c1"># draw setpoint temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T_draw_set</span> <span class="o">=</span> <span class="n">T_draw_set</span>  <span class="c1"># K</span>

        <span class="c1"># fluid properties</span>
        <span class="k">if</span> <span class="n">medium</span> <span class="o">==</span> <span class="s1">&#39;water&#39;</span><span class="p">:</span>
            <span class="c1"># Water properties, :cite:`ASHFund17` 33. table 2</span>
            <span class="c1"># density at 20 degC</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ro</span> <span class="o">=</span> <span class="mf">998.2</span>  <span class="c1"># kg/m3</span>
            <span class="c1"># specific heat content at 20 degC</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shc</span> <span class="o">=</span> <span class="mf">4180.</span>  <span class="c1"># J/(kgK)</span>

        <span class="k">elif</span> <span class="n">medium</span> <span class="o">==</span> <span class="s1">&#39;glycol&#39;</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Recovery efficiency of gas tank water heater</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tank_re</span> <span class="o">=</span> <span class="n">tank_re</span>

        <span class="c1"># Maximum allowed temperature difference between the</span>
        <span class="c1"># upper and the lower tank volume while charging</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dT_approach</span> <span class="o">=</span> <span class="n">dT_param</span>  <span class="c1"># K</span>

        <span class="c1"># initiate allowed dT error below the minimum</span>
        <span class="c1"># tank temperature due to finite timestep length</span>
        <span class="c1"># approximation, in K</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dT_err</span> <span class="o">=</span> <span class="n">dT_err_max</span>  <span class="c1"># K</span>

        <span class="c1"># upper tank volume fraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol_fra_upper</span> <span class="o">=</span> <span class="n">vol_fra_upper</span>
        <span class="c1"># tank height diametar ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_vs_r</span> <span class="o">=</span> <span class="n">h_vs_r</span>

        <span class="c1"># thus lower volume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V_lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol_fra_upper</span><span class="p">)</span>
        <span class="c1"># and upper volume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol_fra_upper</span>

        <span class="c1"># volume</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span>

        <span class="c1"># For tanks with a gas heater input:</span>
        <span class="k">if</span> <span class="n">gas_heater_autosize</span><span class="p">:</span>
            <span class="c1"># Calculate nominal water heater input power</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Q_nom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_to_power</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>

        <span class="c1"># tank heat loss parameters</span>

        <span class="c1"># thermal transmittance through the tank walls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">therm_transm_coef</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thermal_transmittance</span><span class="p">(</span>
            <span class="n">insul_thickness</span><span class="o">=</span><span class="n">insul_thickness</span><span class="p">,</span>
            <span class="n">spec_hea_cond</span><span class="o">=</span><span class="n">spec_hea_cond</span><span class="p">)</span>

        <span class="c1"># if there is a coil, this is its efficiency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coil_eff</span> <span class="o">=</span> <span class="n">coil_eff</span>

        <span class="c1"># areas to calculate thermal losses to environment</span>
        <span class="c1"># e.g. to apply for a solar indirect tank</span>
        <span class="k">if</span> <span class="n">split_tank</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A_lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tank_area</span><span class="p">()[</span><span class="s1">&#39;lower&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tank_area</span><span class="p">()[</span><span class="s1">&#39;upper&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_lower</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_upper</span>
        <span class="c1"># e.g. to apply to the gas tank WH WHAM model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tank_area</span><span class="p">(</span><span class="n">split_tank</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Storage.thermal_tank_dynamics"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Storage.thermal_tank_dynamics">[docs]</a>    <span class="k">def</span> <span class="nf">thermal_tank_dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre_T_amb</span><span class="p">,</span> <span class="n">pre_T_upper</span><span class="p">,</span>
                              <span class="n">pre_T_lower</span><span class="p">,</span> <span class="n">pre_Q_in</span><span class="p">,</span>
                              <span class="n">pre_Q_loss_upper</span><span class="p">,</span> <span class="n">pre_Q_loss_lower</span><span class="p">,</span>
                              <span class="n">pre_T_feed</span><span class="p">,</span> <span class="n">pre_Q_tap</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Partial model of a thermal storage tank.</span>
<span class="sd">        Applies first order forward marching Euler method and updates</span>
<span class="sd">        the tank state for the current timestep</span>
<span class="sd">        based on the enthalpy balance and simplified</span>
<span class="sd">        assumptions about stratification. Thus, all</span>
<span class="sd">        input variables pertain to the previous timestep,</span>
<span class="sd">        while the outputs are solutions for the current timestep.</span>

<span class="sd">        For example partial model application see thermal_tank method.</span>

<span class="sd">        See inline comments for detailed explanation of the model.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            pre_T_amb: float, K</span>
<span class="sd">                Ambient air temperature</span>

<span class="sd">            pre_T_upper: float, K</span>
<span class="sd">                Upper tank volume temperature</span>

<span class="sd">            pre_T_lower: float, K</span>
<span class="sd">                Lower tank volume temperature</span>

<span class="sd">                It is recommended to set equal initial values</span>
<span class="sd">                for pre_T_upper and pre_T_lower</span>

<span class="sd">            pre_Q_in: float, W</span>
<span class="sd">                Total heat gain (e.g. from a coil heat exchanger,</span>
<span class="sd">                a heating element, etc.)</span>

<span class="sd">            pre_Q_loss_upper: float, W</span>
<span class="sd">                Heat loss from the upper tank volume</span>

<span class="sd">            pre_T_lower: float, W</span>
<span class="sd">                Heat loss from the lower tank volume</span>

<span class="sd">            pre_T_feed: float, K</span>
<span class="sd">                Temperature of the water</span>
<span class="sd">                that replenishes the tapped volume</span>
<span class="sd">                (e.g. water main temperature)</span>

<span class="sd">            pre_Q_tap: float, W</span>
<span class="sd">                Heat loss that would occur if the tank</span>
<span class="sd">                volume at pre_T_upper was infinite</span>

<span class="sd">        Returns:</span>

<span class="sd">            res: dict of floats</span>
<span class="sd">                Represent averages in a single timestep.</span>
<span class="sd">                Average temperatures for tank volumes:</span>
<span class="sd">                self.r[self.r[&#39;t_tank_low&#39;]] : lower, K</span>
<span class="sd">                self.r[&#39;t_tank_up&#39;] : upper, K</span>
<span class="sd">                Heat rates:</span>
<span class="sd">                &#39;Q_net&#39; : expected timestep net gain/loss based on inputs, W</span>
<span class="sd">                self.r[&#39;q_dump&#39;] : dumped heat, W</span>
<span class="sd">                &#39;Q_draw&#39; : delivered to load W</span>
<span class="sd">                &#39;Q_draw_unmet&#39; : unmet load due to finite tank volume, W</span>
<span class="sd">                self.r[&#39;q_ovrcool_tank&#39;] : error in balancing due to minimal</span>
<span class="sd">                tank temperature limit assumption in each timestep</span>

<span class="sd">                Note: &#39;Q_draw&#39; + &#39;Q_draw_unmet&#39; = pre_Q_tap</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initiate the dumped heat content as zero:</span>
        <span class="n">Q_dump</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="c1"># Initial assumption is that the tank can deliver the</span>
        <span class="c1"># load that can be tapped based on the upper tank</span>
        <span class="c1"># temperature (see Storage.tap method for details)</span>
        <span class="n">Q_del</span> <span class="o">=</span> <span class="n">pre_Q_tap</span>
        <span class="n">Q_unmet</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1"># initiate the resulting error in heat balance</span>
        <span class="n">Q_overcool</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1"># Get the minimum tank temperature limit</span>
        <span class="n">pre_T_min</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pre_T_amb</span><span class="p">,</span> <span class="n">pre_T_feed</span><span class="p">)</span>

        <span class="c1"># Get net heat gain/loss rate inside the tank</span>
        <span class="n">dQ</span> <span class="o">=</span> <span class="p">(</span><span class="n">pre_Q_in</span> <span class="o">-</span> <span class="n">pre_Q_loss_lower</span> <span class="o">-</span>
              <span class="n">pre_Q_loss_upper</span> <span class="o">-</span> <span class="n">pre_Q_tap</span><span class="p">)</span>

        <span class="c1"># Get net heat gain/loss in a single timestep in J,</span>
        <span class="c1"># assuming timestep given in h!</span>
        <span class="n">dE</span> <span class="o">=</span> <span class="n">UnitConv</span><span class="p">(</span><span class="n">dQ</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span><span class="o">.</span><span class="n">Wh_J</span><span class="p">(</span><span class="n">unit_in</span><span class="o">=</span><span class="s1">&#39;Wh&#39;</span><span class="p">)</span>

        <span class="c1"># Distribution of the net heat gain/loss</span>

        <span class="c1"># net charge</span>
        <span class="k">if</span> <span class="n">dQ</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Q_dump</span><span class="p">,</span> <span class="n">Q_overcool</span><span class="p">,</span> <span class="n">T_lower</span><span class="p">,</span> <span class="n">T_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tank_charge</span><span class="p">(</span>
                <span class="n">pre_Q_tap</span><span class="p">,</span>
                <span class="n">dE</span><span class="p">,</span>
                <span class="n">pre_T_lower</span><span class="p">,</span>
                <span class="n">pre_T_upper</span><span class="p">,</span>
                <span class="n">pre_T_min</span><span class="p">,</span>
                <span class="n">Q_dump</span><span class="p">,</span>
                <span class="n">Q_overcool</span><span class="p">,</span>
                <span class="n">pre_T_amb</span><span class="p">,</span>
                <span class="n">pre_T_feed</span><span class="p">)</span>

        <span class="c1"># net discharge or balanced</span>
        <span class="k">elif</span> <span class="n">dQ</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">Q_del</span><span class="p">,</span> <span class="n">Q_unmet</span><span class="p">,</span> <span class="n">Q_overcool</span><span class="p">,</span> <span class="n">T_lower</span><span class="p">,</span> <span class="n">T_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tank_discharge</span><span class="p">(</span>
                <span class="n">pre_Q_tap</span><span class="p">,</span>
                <span class="n">dE</span><span class="p">,</span>
                <span class="n">pre_T_lower</span><span class="p">,</span>
                <span class="n">pre_T_upper</span><span class="p">,</span>
                <span class="n">pre_T_min</span><span class="p">,</span>
                <span class="n">Q_unmet</span><span class="p">,</span>
                <span class="n">Q_del</span><span class="p">,</span>
                <span class="n">Q_overcool</span><span class="p">,</span>
                <span class="n">pre_T_amb</span><span class="p">,</span>
                <span class="n">pre_T_feed</span><span class="p">)</span>

        <span class="c1"># Check tapped water heat balance</span>
        <span class="k">if</span> <span class="n">pre_Q_tap</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">rel_err</span> <span class="o">=</span> <span class="p">((</span><span class="n">Q_unmet</span> <span class="o">+</span> <span class="n">Q_del</span><span class="p">)</span> <span class="o">-</span> <span class="n">pre_Q_tap</span><span class="p">)</span> <span class="o">/</span> <span class="n">pre_Q_tap</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rel_err</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">01</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Tank delivered </span><span class="si">{}</span><span class="s1"> and unmet </span><span class="si">{}</span><span class="s1"> demand do not balance &#39;</span>\
                      <span class="s1">&#39;with the tank demand setpoint </span><span class="si">{}</span><span class="s1">&#39;</span>
                <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Q_del</span><span class="p">,</span> <span class="n">Q_unmet</span><span class="p">,</span> <span class="n">pre_Q_tap</span><span class="p">))</span>
                <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="c1"># did any part of the algorithm bring the lower tank</span>
        <span class="c1"># temperature above the upper</span>
        <span class="k">if</span> <span class="n">T_lower</span> <span class="o">&gt;</span> <span class="n">T_upper</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Upper tank temperature is below the lower &#39;</span>\
                  <span class="s1">&#39;tank tamperature.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="c1"># pack results</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_tank_low&#39;</span><span class="p">]:</span> <span class="n">T_lower</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_tank_up&#39;</span><span class="p">]:</span> <span class="n">T_upper</span><span class="p">,</span>
               <span class="s1">&#39;Q_net&#39;</span><span class="p">:</span> <span class="n">dQ</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dump&#39;</span><span class="p">]:</span> <span class="n">Q_dump</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_ovrcool_tank&#39;</span><span class="p">]:</span> <span class="n">Q_overcool</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_tank&#39;</span><span class="p">]:</span> <span class="n">Q_del</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet_tank&#39;</span><span class="p">]:</span> <span class="n">Q_unmet</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">res</span></div>

    <span class="k">def</span> <span class="nf">_tank_charge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre_Q_tap</span><span class="p">,</span> <span class="n">dE</span><span class="p">,</span> <span class="n">pre_T_lower</span><span class="p">,</span> <span class="n">pre_T_upper</span><span class="p">,</span>
                     <span class="n">pre_T_min</span><span class="p">,</span> <span class="n">Q_dump</span><span class="p">,</span> <span class="n">Q_overcool</span><span class="p">,</span> <span class="n">pre_T_amb</span><span class="p">,</span> <span class="n">pre_T_feed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Storage charge partial model. While charging the tank</span>
<span class="sd">        assume that stratification happens up to a predefined</span>
<span class="sd">        &quot;stratification limit when charging&quot; temperature difference.</span>
<span class="sd">        This is taken as an empirical value based on observed</span>
<span class="sd">        literature.</span>

<span class="sd">        Assuming uniform tank temperature distribution at initiation,</span>
<span class="sd">        net heat gain is allocated to the upper tank volume until</span>
<span class="sd">        the difference between the temperatures in the upper and</span>
<span class="sd">        in the lower tank volume reaches the empirical temperature</span>
<span class="sd">        difference limit, after which both lower and upper</span>
<span class="sd">        volumes get allocated with heat gain</span>

<span class="sd">        If the upper tank volume reaches the maximum allowed tank</span>
<span class="sd">        temperature limit, the thermostat will prevent the storage</span>
<span class="sd">        from overcharging.</span>

<span class="sd">        See ```thermal_tank_dynamics``` method</span>
<span class="sd">        for parameters and returns description.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dE</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;This method does not apply if there are no net &#39;</span>\
                   <span class="s1">&#39;heat gains to the tank.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">pre_T_upper</span> <span class="o">-</span> <span class="n">pre_T_lower</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT_approach</span><span class="p">:</span>

            <span class="c1"># Temperature increase to upper volume that would</span>
            <span class="c1"># be achieved should all the gain be allocated to it</span>
            <span class="n">dT_upper</span> <span class="o">=</span> <span class="p">(</span><span class="n">dE</span> <span class="o">/</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_upper</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ro</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shc</span><span class="p">))</span>

            <span class="c1"># Nonetheless, allow heating only up to the predefined</span>
            <span class="c1"># charging temperature difference between the upper</span>
            <span class="c1"># and the lower tank volume</span>
            <span class="n">dT_rem</span> <span class="o">=</span> <span class="p">((</span><span class="n">dT_upper</span> <span class="o">+</span> <span class="n">pre_T_upper</span><span class="p">)</span> <span class="o">-</span>
                      <span class="p">(</span><span class="n">pre_T_lower</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT_approach</span><span class="p">))</span>

            <span class="c1"># Any remaining heat gain after reaching the temperature</span>
            <span class="c1"># difference limit gets allocated to both volumes:</span>
            <span class="k">if</span> <span class="n">dT_rem</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dT_rem_both</span> <span class="o">=</span> <span class="n">dT_rem</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_upper</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
                <span class="n">T_upper</span> <span class="o">=</span> <span class="n">pre_T_upper</span> <span class="o">+</span> <span class="n">dT_upper</span> <span class="o">-</span> <span class="n">dT_rem</span> <span class="o">+</span> <span class="n">dT_rem_both</span>
                <span class="n">T_lower</span> <span class="o">=</span> <span class="n">pre_T_lower</span> <span class="o">+</span> <span class="n">dT_rem_both</span>

            <span class="c1"># otherwise heat up only the upper volume</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">T_upper</span> <span class="o">=</span> <span class="n">pre_T_upper</span> <span class="o">+</span> <span class="n">dT_upper</span>
                <span class="n">T_lower</span> <span class="o">=</span> <span class="n">pre_T_lower</span>

        <span class="c1"># Once stratification limit when charging has been</span>
        <span class="c1"># achieved, it remains maintained</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">pre_T_upper</span> <span class="o">-</span> <span class="n">pre_T_lower</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT_approach</span><span class="p">:</span>

            <span class="c1"># get the lower volume up to</span>
            <span class="c1"># pre_T_upper - self.dT_approach</span>
            <span class="n">dT_lower_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">pre_T_upper</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT_approach</span><span class="p">)</span> <span class="o">-</span> <span class="n">pre_T_lower</span>
            <span class="n">dT_lower</span> <span class="o">=</span> <span class="p">(</span><span class="n">dE</span> <span class="o">/</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_lower</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ro</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shc</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">dT_lower</span> <span class="o">&lt;=</span> <span class="n">dT_lower_max</span><span class="p">:</span>
                <span class="n">T_lower</span> <span class="o">=</span> <span class="n">pre_T_lower</span> <span class="o">+</span> <span class="n">dT_lower</span>
                <span class="n">T_upper</span> <span class="o">=</span> <span class="n">pre_T_upper</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">T_lower</span> <span class="o">=</span> <span class="n">pre_T_lower</span> <span class="o">+</span> <span class="n">dT_lower_max</span>
                <span class="n">dT_rem</span> <span class="o">=</span> <span class="p">((</span><span class="n">dT_lower</span> <span class="o">-</span> <span class="n">dT_lower_max</span><span class="p">)</span> <span class="o">*</span>
                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_lower</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">))</span>
                <span class="c1"># after heating up the lower part of the tank</span>
                <span class="c1"># the temperature difference when charging</span>
                <span class="c1"># has been reached and the rest of the heat</span>
                <span class="c1"># should get assigned in parallel</span>
                <span class="n">T_upper</span> <span class="o">=</span> <span class="n">pre_T_upper</span> <span class="o">+</span> <span class="n">dT_rem</span>
                <span class="n">T_lower</span> <span class="o">+=</span> <span class="n">dT_rem</span>

        <span class="c1"># Check the behavior of tank temperatures</span>
        <span class="c1"># related to the min tank temperature</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">T_upper</span> <span class="o">&lt;</span> <span class="n">pre_T_min</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">T_lower</span> <span class="o">&lt;</span> <span class="n">pre_T_min</span><span class="p">):</span>
            <span class="n">Q_overcool</span><span class="p">,</span> <span class="n">T_upper</span><span class="p">,</span> <span class="n">T_lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overcooling</span><span class="p">(</span>
                <span class="n">pre_T_min</span><span class="p">,</span>
                <span class="n">T_upper</span><span class="p">,</span>
                <span class="n">T_lower</span><span class="p">,</span>
                <span class="n">pre_T_amb</span><span class="p">,</span>
                <span class="n">pre_T_feed</span><span class="p">,</span>
                <span class="n">discharge</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># would the conditions overcharge the tank?</span>
        <span class="k">if</span> <span class="n">T_upper</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_max</span><span class="p">:</span>
            <span class="n">T_upper</span><span class="p">,</span> <span class="n">T_lower</span><span class="p">,</span> <span class="n">Q_dump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thermostatic_safety_valve</span><span class="p">(</span>
                <span class="n">T_upper</span><span class="p">,</span>
                <span class="n">T_lower</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Q_dump</span><span class="p">,</span> <span class="n">Q_overcool</span><span class="p">,</span> <span class="n">T_lower</span><span class="p">,</span> <span class="n">T_upper</span>

    <span class="k">def</span> <span class="nf">_tank_discharge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre_Q_tap</span><span class="p">,</span> <span class="n">dE</span><span class="p">,</span> <span class="n">pre_T_lower</span><span class="p">,</span> <span class="n">pre_T_upper</span><span class="p">,</span>
                        <span class="n">pre_T_min</span><span class="p">,</span> <span class="n">Q_unmet</span><span class="p">,</span> <span class="n">Q_del</span><span class="p">,</span> <span class="n">Q_overcool</span><span class="p">,</span> <span class="n">pre_T_amb</span><span class="p">,</span>
                        <span class="n">pre_T_feed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Storage discharge partial model. When there are no gains</span>
<span class="sd">        to the tank:</span>

<span class="sd">        * if there is water draw the model reduces temperature in both</span>
<span class="sd">          parts of the tank. This emulates the propagation of</span>
<span class="sd">          the water main as the DHW is tapped and shifting the</span>
<span class="sd">          temperature profile downwards in the entire tank.</span>

<span class="sd">        * if there is no water draw, assumes stagnation mode. Cools off</span>
<span class="sd">          the lower tank volume first, after which the upper tank volume</span>
<span class="sd">          starts cooling off, depending on the heat loss amount.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            dE: float</span>
<span class="sd">                Timestep net heat balance inside the tank, this method assumes</span>
<span class="sd">                it not larger than zero.</span>

<span class="sd">        See ```thermal_tank_dynamics``` method</span>
<span class="sd">        for the rest of the parameters and returns description.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">dE</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;This method cannot be called if the timestep heat &#39;</span>\
                   <span class="s1">&#39;balance is positive.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="c1"># water draw exists</span>
        <span class="k">if</span> <span class="n">pre_Q_tap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># cool in parallel as low as possible (until the lower</span>
            <span class="c1"># volume hits the minimum). This mimics the bulk vertical</span>
            <span class="c1"># motion of the water with the hot being tapped from</span>
            <span class="c1"># the top and the water main entering from the bottom</span>

            <span class="c1"># theoretical temperature reduction if it would be</span>
            <span class="c1"># possible to satisfy the entire loss from the tank volume</span>
            <span class="n">dT</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="p">(</span><span class="n">dE</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span>  <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ro</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shc</span><span class="p">))</span>

            <span class="c1"># maximum possible temperature reduction to the lower volume</span>
            <span class="n">dT_lower_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">pre_T_lower</span> <span class="o">-</span> <span class="n">pre_T_min</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">dT</span> <span class="o">&lt;=</span> <span class="n">dT_lower_max</span><span class="p">:</span>
                <span class="c1"># The entire demand got satisfied</span>
                <span class="n">T_upper</span> <span class="o">=</span> <span class="n">pre_T_upper</span> <span class="o">-</span> <span class="n">dT</span>
                <span class="n">T_lower</span> <span class="o">=</span> <span class="n">pre_T_lower</span> <span class="o">-</span> <span class="n">dT</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Cool in paralled until the lower volume is at</span>
                <span class="c1"># its minimum temperature</span>
                <span class="n">T_upper</span> <span class="o">=</span> <span class="n">pre_T_upper</span> <span class="o">-</span> <span class="n">dT_lower_max</span>
                <span class="n">T_lower</span> <span class="o">=</span> <span class="n">pre_T_lower</span> <span class="o">-</span> <span class="n">dT_lower_max</span>

                <span class="c1"># Try to take the rest of the loss from the</span>
                <span class="c1"># upper volume</span>
                <span class="n">dT_upper</span> <span class="o">=</span> <span class="p">(</span><span class="n">dT</span> <span class="o">-</span> <span class="n">dT_lower_max</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_upper</span><span class="p">)</span>

                <span class="n">dT_upper_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">T_upper</span> <span class="o">-</span> <span class="n">pre_T_min</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">dT_upper</span> <span class="o">&lt;</span> <span class="n">dT_upper_max</span><span class="p">:</span>
                    <span class="n">T_upper</span> <span class="o">-=</span> <span class="n">dT_upper</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">T_upper</span> <span class="o">-=</span> <span class="n">dT_upper_max</span>

                    <span class="n">Q_unmet</span> <span class="o">=</span> <span class="n">UnitConv</span><span class="p">(</span>
                        <span class="p">((</span><span class="n">dT_upper</span> <span class="o">-</span> <span class="n">dT_upper_max</span><span class="p">)</span> <span class="o">*</span>
                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_upper</span>  <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ro</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shc</span><span class="p">)))</span><span class="o">.</span><span class="n">Wh_J</span><span class="p">(</span><span class="n">unit_in</span><span class="o">=</span><span class="s1">&#39;J&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>
                    <span class="n">Q_del</span> <span class="o">-=</span> <span class="n">Q_unmet</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">T_upper</span> <span class="o">&lt;</span> <span class="n">pre_T_min</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">T_lower</span> <span class="o">&lt;</span> <span class="n">pre_T_min</span><span class="p">):</span>
                <span class="n">Q_overcool</span><span class="p">,</span> <span class="n">T_upper</span><span class="p">,</span> <span class="n">T_lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overcooling</span><span class="p">(</span>
                    <span class="n">pre_T_min</span><span class="p">,</span>
                    <span class="n">T_upper</span><span class="p">,</span>
                    <span class="n">T_lower</span><span class="p">,</span>
                    <span class="n">pre_T_amb</span><span class="p">,</span>
                    <span class="n">pre_T_feed</span><span class="p">,</span>
                    <span class="n">discharge</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># no water draw (stagnation)</span>
        <span class="k">elif</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pre_Q_tap</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="c1"># See what would be the temperature difference</span>
            <span class="c1"># should all the heat be lost from the lower</span>
            <span class="c1"># part of the tank</span>
            <span class="n">dT_lower_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">dE</span> <span class="o">/</span>
                            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_lower</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ro</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shc</span><span class="p">))</span>

            <span class="c1"># allow cooling off of the lower part of the tank</span>
            <span class="c1"># either for the full amount of losses or down</span>
            <span class="c1"># to ambient temperature increased in the approach</span>
            <span class="c1"># temperature, whichever is larger</span>
            <span class="n">T_lower</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">pre_T_lower</span> <span class="o">+</span> <span class="n">dT_lower_max</span><span class="p">),</span>\
                          <span class="p">(</span><span class="n">pre_T_min</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT_approach</span><span class="p">))</span>
            <span class="n">T_upper</span> <span class="o">=</span> <span class="n">pre_T_upper</span>

            <span class="c1"># Would this temperature difference bring</span>
            <span class="c1"># the lower part of the tank below the</span>
            <span class="c1"># minimal allowed temperature and how much lower?</span>
            <span class="n">dT_lim_lower</span> <span class="o">=</span> <span class="p">((</span><span class="n">pre_T_min</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT_approach</span><span class="p">)</span> <span class="o">-</span>
                            <span class="p">(</span><span class="n">pre_T_lower</span> <span class="o">+</span> <span class="n">dT_lower_max</span><span class="p">))</span>

            <span class="c1"># If exists, assign that remaining part of heat loss</span>
            <span class="c1"># to the upper part of the tank</span>
            <span class="k">if</span> <span class="n">dT_lim_lower</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># get the eqivalent temperature difference for the</span>
                <span class="c1"># upper part of the tank</span>
                <span class="n">dT_to_upper</span> <span class="o">=</span> <span class="n">dT_lim_lower</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_lower</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_upper</span><span class="p">)</span>

                <span class="c1"># allow cooling off of the upper part of the tank</span>
                <span class="c1"># either for the full amount of losses or down</span>
                <span class="c1"># to ambient temperature increased in the approach</span>
                <span class="c1"># temperature, whichever is larger</span>
                <span class="n">T_upper</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">pre_T_upper</span> <span class="o">-</span> <span class="n">dT_to_upper</span><span class="p">),</span>
                              <span class="p">(</span><span class="n">pre_T_min</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT_approach</span><span class="p">))</span>

                <span class="c1"># If any heat loss remains, cool both volumes equally</span>
                <span class="n">dT_lim_upper</span> <span class="o">=</span> <span class="p">((</span><span class="n">pre_T_min</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT_approach</span><span class="p">)</span> <span class="o">-</span>
                                <span class="p">(</span><span class="n">pre_T_upper</span> <span class="o">-</span> <span class="n">dT_to_upper</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">dT_lim_upper</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Get temperature difference for both parts</span>
                    <span class="c1"># of the tank</span>
                    <span class="n">dT_to_both</span> <span class="o">=</span> <span class="n">dT_lim_upper</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_upper</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
                    <span class="n">T_upper</span> <span class="o">=</span> <span class="n">T_upper</span> <span class="o">-</span> <span class="n">dT_to_both</span>
                    <span class="n">T_lower</span> <span class="o">=</span> <span class="n">T_lower</span> <span class="o">-</span> <span class="n">dT_to_both</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">T_upper</span> <span class="o">&lt;</span> <span class="n">pre_T_min</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">T_lower</span> <span class="o">&lt;</span> <span class="n">pre_T_min</span><span class="p">):</span>
                <span class="n">Q_overcool</span><span class="p">,</span> <span class="n">T_upper</span><span class="p">,</span> <span class="n">T_lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_overcooling</span><span class="p">(</span>
                    <span class="n">pre_T_min</span><span class="p">,</span>
                    <span class="n">T_upper</span><span class="p">,</span>
                    <span class="n">T_lower</span><span class="p">,</span>
                    <span class="n">pre_T_amb</span><span class="p">,</span>
                    <span class="n">pre_T_feed</span><span class="p">,</span>
                    <span class="n">discharge</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Q_del</span><span class="p">,</span> <span class="n">Q_unmet</span><span class="p">,</span> <span class="n">Q_overcool</span><span class="p">,</span> <span class="n">T_lower</span><span class="p">,</span> <span class="n">T_upper</span>

    <span class="k">def</span> <span class="nf">_thermostatic_safety_valve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T_upper</span><span class="p">,</span> <span class="n">T_lower</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This emulates the behavior of a thermostatic</span>
<span class="sd">        safety valve placed at the top of the tank to prevent</span>
<span class="sd">        overheating.</span>

<span class="sd">        If the upper tank temperature exceeds the maximum</span>
<span class="sd">        tank temperature limit, charge the lower</span>
<span class="sd">        tank volume up to the temperature of the upper less the</span>
<span class="sd">        predifined tempearture difference if possible and</span>
<span class="sd">        dump any remaining heat.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            T_upper: float, K</span>
<span class="sd">                Upper tank volume temperature at the end of</span>
<span class="sd">                a timestep</span>

<span class="sd">            T_lower: float, K</span>
<span class="sd">                Lower tank volume temperature at the end of</span>
<span class="sd">                a timestep</span>

<span class="sd">        Returns:</span>

<span class="sd">            T_upper: float, K</span>
<span class="sd">                Updated upper tank volume temperature</span>

<span class="sd">            T_lower: float, K</span>
<span class="sd">                Updated lower tank volume temperature</span>

<span class="sd">            Q_dump: float, W</span>
<span class="sd">                Heat dumped if the tank gets overcharged</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The thermostat got triggered!</span>
        <span class="c1"># Get the excess heat and stop charging the tank</span>
        <span class="n">E_dump</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">V_upper</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ro</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shc</span><span class="p">)</span> <span class="o">*</span>
                  <span class="p">(</span><span class="n">T_upper</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_max</span><span class="p">))</span>
        <span class="n">T_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_max</span>
        <span class="c1"># Was the charge high enough to overcharge the</span>
        <span class="c1"># lower part of the tank as well?</span>
        <span class="k">if</span> <span class="n">T_lower</span> <span class="o">&gt;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT_approach</span><span class="p">):</span>
            <span class="n">E_dump</span> <span class="o">+=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">V_lower</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ro</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shc</span><span class="p">)</span>
                       <span class="o">*</span> <span class="p">(</span><span class="n">T_lower</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT_approach</span><span class="p">)))</span>
            <span class="n">T_lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_max</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT_approach</span>

        <span class="c1"># Convert to average timestep heat rate</span>
        <span class="n">Q_dump</span> <span class="o">=</span> <span class="n">UnitConv</span><span class="p">(</span><span class="n">E_dump</span><span class="p">)</span><span class="o">.</span><span class="n">Wh_J</span><span class="p">(</span><span class="n">unit_in</span><span class="o">=</span><span class="s1">&#39;J&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

        <span class="k">return</span> <span class="n">T_upper</span><span class="p">,</span> <span class="n">T_lower</span><span class="p">,</span> <span class="n">Q_dump</span>

    <span class="k">def</span> <span class="nf">_overcooling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre_T_min</span><span class="p">,</span> <span class="n">T_upper</span><span class="p">,</span> <span class="n">T_lower</span><span class="p">,</span>
                     <span class="n">pre_T_amb</span><span class="p">,</span> <span class="n">pre_T_feed</span><span class="p">,</span> <span class="n">discharge</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Overcooling is an event when the</span>
<span class="sd">        resulting tank temperature is below the</span>
<span class="sd">        assumed minimum (smaller of the tank feed and</span>
<span class="sd">        the ambient temperature). It can occur if:</span>

<span class="sd">        * Heat loss and tap from the tank is too high,</span>
<span class="sd">          in which case we declare some unmet demand</span>
<span class="sd">          and limit the tank temperatures</span>
<span class="sd">        * The tank is slightly colder due to a lower</span>
<span class="sd">          ambient or water main temperature in the</span>
<span class="sd">          previous timesteps. This is allowed.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            pre_T_min: float, K</span>
<span class="sd">                Minimum tank temperature limit</span>

<span class="sd">            T_upper: float, K</span>
<span class="sd">                Upper tank volume temperature</span>

<span class="sd">            T_lower: float, K</span>
<span class="sd">                Lower tank volume temperature</span>

<span class="sd">            pre_T_amb, pre_T_feed: floats, K</span>
<span class="sd">                Carried through for error handling</span>

<span class="sd">            discharge: boolean</span>
<span class="sd">                If true, resets any temperatures</span>
<span class="sd">                below the theoretical limit to that</span>
<span class="sd">                limit</span>

<span class="sd">        Returns:</span>

<span class="sd">            T_upper: float, K</span>
<span class="sd">                Updated upper tank volume temperature</span>

<span class="sd">            T_lower: float, K</span>
<span class="sd">                Updated lower tank volume temperature</span>

<span class="sd">            Q_overcool: float, W</span>
<span class="sd">                Error in balancing due to minimal tank</span>
<span class="sd">                temperature limit assumption for the</span>
<span class="sd">                timestep</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check the extent of 2nd law violation</span>
        <span class="c1"># and record it as an error in balancing</span>
        <span class="n">dT_overcool</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">pre_T_min</span> <span class="o">-</span> <span class="n">T_upper</span><span class="p">),</span>
                          <span class="p">(</span><span class="n">pre_T_min</span> <span class="o">-</span> <span class="n">T_lower</span><span class="p">))</span>

        <span class="c1"># How much of the assumed heat loss</span>
        <span class="c1"># did not occur</span>
        <span class="c1"># due to physical constraints</span>
        <span class="n">E_overcool</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ro</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shc</span> <span class="o">*</span>
                      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_upper</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">pre_T_min</span> <span class="o">-</span> <span class="n">T_upper</span><span class="p">))</span> <span class="o">+</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">V_lower</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="p">(</span><span class="n">pre_T_min</span> <span class="o">-</span> <span class="n">T_lower</span><span class="p">))))</span>

        <span class="n">Q_overcool</span> <span class="o">=</span> <span class="n">UnitConv</span><span class="p">(</span><span class="n">E_overcool</span><span class="p">)</span><span class="o">.</span><span class="n">Wh_J</span><span class="p">(</span><span class="n">unit_in</span><span class="o">=</span><span class="s1">&#39;J&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span>

        <span class="k">if</span> <span class="n">discharge</span><span class="p">:</span>
            <span class="c1"># set the achieved tank temperature</span>
            <span class="n">T_upper</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pre_T_min</span><span class="p">,</span> <span class="n">T_upper</span><span class="p">)</span>
            <span class="n">T_lower</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pre_T_min</span><span class="p">,</span> <span class="n">T_lower</span><span class="p">)</span>

        <span class="c1"># if the tank is well sized for the load, the</span>
        <span class="c1"># allowed overcooling will be small, however</span>
        <span class="c1"># a fraction of a degree is likely to occur.</span>
        <span class="c1"># the warning is provided if the overcooling</span>
        <span class="c1"># temperature difference is unusually high</span>
        <span class="k">if</span> <span class="n">dT_overcool</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT_err</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Cooling off </span><span class="si">{}</span><span class="s1"> K below temperature&#39;</span>\
                  <span class="s1">&#39; limit. This is balanced as:&#39;</span>\
                  <span class="s1">&#39; a) allowed, since charging: </span><span class="si">{}</span><span class="s1">, &#39;</span>\
                  <span class="s1">&#39; b) declared unmet demand, since discharging: </span><span class="si">{}</span><span class="s1">;&#39;</span>\
                  <span class="s1">&#39; Ambient T: </span><span class="si">{}</span><span class="s1">, Feed T: </span><span class="si">{}</span><span class="s1">.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">round</span><span class="p">(</span><span class="n">dT_overcool</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                <span class="ow">not</span> <span class="n">discharge</span><span class="p">,</span>
                <span class="n">discharge</span><span class="p">,</span>
                <span class="n">pre_T_amb</span><span class="p">,</span>
                <span class="n">pre_T_feed</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">Q_overcool</span><span class="p">,</span> <span class="n">T_upper</span><span class="p">,</span> <span class="n">T_lower</span>

<div class="viewcode-block" id="Storage.thermal_tank"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Storage.thermal_tank">[docs]</a>    <span class="k">def</span> <span class="nf">thermal_tank</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre_T_amb</span><span class="o">=</span><span class="mf">293.15</span><span class="p">,</span> <span class="n">pre_T_feed</span><span class="o">=</span><span class="mf">291.15</span><span class="p">,</span>
                     <span class="n">pre_T_upper</span><span class="o">=</span><span class="mf">328.15</span><span class="p">,</span> <span class="n">pre_T_lower</span><span class="o">=</span><span class="mf">323.15</span><span class="p">,</span>
                     <span class="n">pre_V_tap</span><span class="o">=.</span><span class="mi">00757</span><span class="p">,</span> <span class="n">pre_Q_in</span><span class="o">=</span><span class="mf">400.</span><span class="p">,</span>
                     <span class="n">max_V_tap</span><span class="o">=</span><span class="mf">0.1514</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Model of a thermal storage tank with:</span>

<span class="sd">        * coil heat exchanger for the solar gains</span>
<span class="sd">        * DHW tap at the top of the tank</span>
<span class="sd">        * recharge tap at the bottom of the tank</span>

<span class="sd">        The model can be instantiated as a:</span>

<span class="sd">        * solar thermal tank</span>
<span class="sd">        * heat pump tank</span>

<span class="sd">        Parameters:</span>

<span class="sd">            type: string</span>
<span class="sd">                &#39;solar&#39; - solar tank (assumes</span>
<span class="sd">                that heated fluid from a solar collector is circulated</span>
<span class="sd">                through an in-tank-coil)</span>
<span class="sd">                &#39;hp&#39; - heat pump tank (assumes an inbuilt heat pump</span>
<span class="sd">                as a main heat source)</span>

<span class="sd">                The type will affect output labeling and heat transfer</span>
<span class="sd">                efficiency.</span>


<span class="sd">            pre_T_amb: float, K</span>
<span class="sd">                Ambient temperature</span>

<span class="sd">            pre_T_feed: float, K</span>
<span class="sd">                Temperature of the water</span>
<span class="sd">                that replenishes the tapped volume</span>
<span class="sd">                (e.g. water main temperature)</span>

<span class="sd">            pre_T_upper: float, K</span>
<span class="sd">                Upper tank volume temperature</span>

<span class="sd">            pre_T_lower: float, K</span>
<span class="sd">                Lower tank volume temperature</span>

<span class="sd">            pre_Q_in: float, W</span>
<span class="sd">                Heat gain passed to in-tank coil from solar collector</span>
<span class="sd">                or from a heat pump, depending on the type</span>

<span class="sd">            pre_V_tap: float, m3/h</span>
<span class="sd">                Volume of water tapped from the top of the tank</span>

<span class="sd">            max_V_tap: float, m3/h</span>
<span class="sd">                Annual peak flow</span>

<span class="sd">        Returns:</span>

<span class="sd">            res: dict</span>
<span class="sd">                Single Timestep input and output values for temperatures [K]</span>
<span class="sd">                and heat rates [W]:</span>

<span class="sd">               {net_gain_label : pre_Q_in_net,\</span>
<span class="sd">                self.r[&#39;q_loss_low&#39;] : pre_Q_loss_lower,\</span>
<span class="sd">                self.r[&#39;q_loss_up&#39;] : pre_Q_loss_upper,\</span>
<span class="sd">                # demand, delivered and unmet heat</span>
<span class="sd">                # (between tap setpoint and water main)</span>
<span class="sd">                self.r[&#39;q_dem&#39;] : tap[&#39;net_dem&#39;],\</span>
<span class="sd">                self.r[&#39;q_dem_tot&#39;] : tap[&#39;tot_dem&#39;],\</span>
<span class="sd">                self.r[&#39;q_del_tank&#39;] : tank[self.r[&#39;q_del_tank&#39;]],\</span>
<span class="sd">                self.r[&#39;q_unmet_tank&#39;] : \</span>
<span class="sd">                    np.round(\</span>
<span class="sd">                tank[self.r[&#39;q_unmet_tank&#39;]] + tap[&#39;unmet_heat_rate&#39;], 2),\</span>
<span class="sd">                self.r[&#39;q_dump&#39;] : tank[self.r[&#39;q_dump&#39;]],\</span>
<span class="sd">                self.r[&#39;q_ovrcool_tank&#39;] : tank[self.r[&#39;q_ovrcool_tank&#39;]],\</span>
<span class="sd">                self.r[&#39;q_dem_balance&#39;] : np.round(Q_dem_balance),\</span>
<span class="sd">                # average temperatures for tank volumes</span>
<span class="sd">                self.r[&#39;t_tank_low&#39;] : tank[self.r[&#39;t_tank_low&#39;]],\</span>
<span class="sd">                self.r[&#39;t_tank_up&#39;] : tank[self.r[&#39;t_tank_up&#39;]],\</span>
<span class="sd">                self.r[&#39;dt_dist&#39;] : dist[&#39;dt_dist&#39;],\</span>
<span class="sd">                self.r[&#39;t_set&#39;] : self.T_draw_set,\</span>
<span class="sd">                self.r[&#39;q_dist_loss&#39;] : dist[&#39;heat_loss&#39;],</span>
<span class="sd">                self.r[&#39;flow_on_frac&#39;] : dist[&#39;flow_on_frac&#39;]}</span>

<span class="sd">                Temperatures in K, heat rates in W</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Heat loss from the upper tank volume</span>
        <span class="n">pre_Q_loss_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thermal_loss</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">therm_transm_coef</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A_upper</span><span class="p">,</span>
            <span class="n">pre_T_amb</span><span class="p">,</span>
            <span class="n">pre_T_upper</span><span class="p">)</span>

        <span class="c1"># Heat loss from the lower tank volume</span>
        <span class="n">pre_Q_loss_lower</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thermal_loss</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">therm_transm_coef</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">A_lower</span><span class="p">,</span>
            <span class="n">pre_T_amb</span><span class="p">,</span>
            <span class="n">pre_T_lower</span><span class="p">)</span>

        <span class="c1"># distribution system temperature drop and heat loss</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">pipe_losses</span><span class="p">(</span>
            <span class="n">T_amb</span><span class="o">=</span><span class="n">pre_T_amb</span><span class="p">,</span>
            <span class="n">T_in</span><span class="o">=</span><span class="n">pre_T_upper</span><span class="p">,</span>
            <span class="n">V_tap</span><span class="o">=</span><span class="n">pre_V_tap</span><span class="p">,</span>
            <span class="n">max_V_tap</span><span class="o">=</span><span class="n">max_V_tap</span><span class="p">)</span>

        <span class="c1"># Heat loss due to tapping water from</span>
        <span class="c1"># the upper tank volume and</span>
        <span class="c1"># replenishing it by water main. This</span>
        <span class="c1"># method also calculates any upfront unmet load</span>
        <span class="c1"># if the upper tank temperature is below the</span>
        <span class="c1"># dhw setpoint + the estimated distribution temperature drop</span>
        <span class="n">tap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tap</span><span class="p">(</span>
            <span class="n">pre_V_tap</span><span class="p">,</span>
            <span class="n">pre_T_upper</span><span class="p">,</span>
            <span class="n">pre_T_feed</span><span class="p">,</span>
            <span class="n">dT_loss</span><span class="o">=</span><span class="n">dist</span><span class="p">[</span><span class="s1">&#39;dt_dist&#39;</span><span class="p">],</span>
            <span class="n">T_draw_min</span><span class="o">=</span><span class="n">pre_T_feed</span> <span class="o">+</span> <span class="n">dist</span><span class="p">[</span><span class="s1">&#39;dt_dist&#39;</span><span class="p">])</span>

        <span class="n">pre_Q_tap</span> <span class="o">=</span> <span class="n">tap</span><span class="p">[</span><span class="s1">&#39;heat_rate&#39;</span><span class="p">]</span>

        <span class="c1"># Net heat gains to the tank</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;sol_tank&#39;</span><span class="p">:</span>
            <span class="c1"># assumes a simple coil efficiency multiplier</span>
            <span class="n">pre_Q_in_net</span> <span class="o">=</span> <span class="n">pre_Q_in</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">coil_eff</span>
            <span class="n">net_gain_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_sol&#39;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;hp_tank&#39;</span><span class="p">:</span>
            <span class="c1"># empirical data used describes net gain from</span>
            <span class="c1"># a heat pump evaporator</span>
            <span class="n">pre_Q_in_net</span> <span class="o">=</span> <span class="n">pre_Q_in</span> <span class="o">*</span> <span class="mf">1.</span>
            <span class="n">net_gain_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_hp&#39;</span><span class="p">]</span>

        <span class="c1"># run a single timestep of tank behavior</span>
        <span class="n">tank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">thermal_tank_dynamics</span><span class="p">(</span>
            <span class="n">pre_T_amb</span><span class="p">,</span>
            <span class="n">pre_T_upper</span><span class="p">,</span>
            <span class="n">pre_T_lower</span><span class="p">,</span>
            <span class="n">pre_Q_in_net</span><span class="p">,</span>
            <span class="n">pre_Q_loss_upper</span><span class="p">,</span>
            <span class="n">pre_Q_loss_lower</span><span class="p">,</span>
            <span class="n">pre_T_feed</span><span class="p">,</span>
            <span class="n">tap</span><span class="p">[</span><span class="s1">&#39;heat_rate&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;sol_tank&#39;</span><span class="p">:</span>
            <span class="c1"># Get the collector return temperature</span>
            <span class="n">T_sol_col_return</span> <span class="o">=</span> <span class="n">tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_tank_low&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dT_approach</span>

        <span class="c1"># check total demand balance (compare total heat</span>
        <span class="c1"># requirement needed to increase the water temperature of the</span>
        <span class="c1"># timestep&#39;s draw volume up to the setpoint temperature increased</span>
        <span class="c1"># in any distribution losses with the sum of heat delivered by the</span>
        <span class="c1"># tank, heat unmet due to finite tank volume and thermal losses,</span>
        <span class="c1"># and heat unmet due to the tank temperature at the upper tank volume)</span>
        <span class="n">Q_del_and_unmet</span> <span class="o">=</span> <span class="p">(</span><span class="n">tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_tank&#39;</span><span class="p">]]</span> <span class="o">+</span>
                           <span class="n">tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet_tank&#39;</span><span class="p">]]</span> <span class="o">+</span>
                           <span class="n">tap</span><span class="p">[</span><span class="s1">&#39;unmet_heat_rate&#39;</span><span class="p">])</span>

        <span class="n">Q_dem_balance</span> <span class="o">=</span> <span class="n">tap</span><span class="p">[</span><span class="s1">&#39;tot_dem&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">Q_del_and_unmet</span>

        <span class="c1"># Include all states</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="n">net_gain_label</span><span class="p">:</span> <span class="n">pre_Q_in_net</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_loss_low&#39;</span><span class="p">]:</span> <span class="n">pre_Q_loss_lower</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_loss_up&#39;</span><span class="p">]:</span> <span class="n">pre_Q_loss_upper</span><span class="p">,</span>
               <span class="c1"># demand, delivered and unmet heat</span>
               <span class="c1"># (between tap setpoint and water main)</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]:</span> <span class="n">tap</span><span class="p">[</span><span class="s1">&#39;net_dem&#39;</span><span class="p">],</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem_tot&#39;</span><span class="p">]:</span> <span class="n">tap</span><span class="p">[</span><span class="s1">&#39;tot_dem&#39;</span><span class="p">],</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_tank&#39;</span><span class="p">]:</span> <span class="n">tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del_tank&#39;</span><span class="p">]],</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet_tank&#39;</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                   <span class="n">tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_unmet_tank&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">tap</span><span class="p">[</span><span class="s1">&#39;unmet_heat_rate&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">),</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dump&#39;</span><span class="p">]:</span> <span class="n">tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dump&#39;</span><span class="p">]],</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_ovrcool_tank&#39;</span><span class="p">]:</span> <span class="n">tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_ovrcool_tank&#39;</span><span class="p">]],</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem_balance&#39;</span><span class="p">]:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">Q_dem_balance</span><span class="p">),</span>
               <span class="c1"># average temperatures for tank volumes</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_tank_low&#39;</span><span class="p">]:</span> <span class="n">tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_tank_low&#39;</span><span class="p">]],</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_tank_up&#39;</span><span class="p">]:</span> <span class="n">tank</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_tank_up&#39;</span><span class="p">]],</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;dt_dist&#39;</span><span class="p">]:</span> <span class="n">dist</span><span class="p">[</span><span class="s1">&#39;dt_dist&#39;</span><span class="p">],</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_set&#39;</span><span class="p">]:</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_draw_set</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dist_loss&#39;</span><span class="p">]:</span> <span class="n">dist</span><span class="p">[</span><span class="s1">&#39;heat_loss&#39;</span><span class="p">],</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;flow_on_frac&#39;</span><span class="p">]:</span> <span class="n">dist</span><span class="p">[</span><span class="s1">&#39;flow_on_frac&#39;</span><span class="p">]}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;sol_tank&#39;</span><span class="p">:</span>
           <span class="c1"># to heat source (e.g. collector)</span>
           <span class="n">res</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;t_coil_out&#39;</span><span class="p">]</span> <span class="p">:</span> <span class="n">T_sol_col_return</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">res</span></div>

<span class="c1"># ----------------------------------------------------------------------------</span>
<span class="c1"># this belongs to models.py as a variety of backup</span>
<span class="c1"># gas_comb_eff, el_res_eff</span>
<span class="c1">#</span>
<span class="c1">#         # *mg gas tank specific</span>
<span class="c1">#</span>
<span class="c1">#         # turn on the gas burner for the whole</span>
<span class="c1">#         # or a fraction of the timestep to</span>
<span class="c1">#         # reach the temperature setpoint, increased in any</span>
<span class="c1">#         # anticipated distribution losses, in the upper</span>
<span class="c1">#         # half of the tank</span>
<span class="c1">#         if tank[self.r[&#39;t_tank_up&#39;]] &lt; \</span>
<span class="c1">#             (self.T_draw_set + dT_dist):</span>
<span class="c1">#</span>
<span class="c1">#             # heat rate that would be needed to reach the setpoint in</span>
<span class="c1">#             # the upper volume of the tank</span>
<span class="c1">#             dT = max((self.T_draw_set + dT_dist - \</span>
<span class="c1">#                 tank[self.r[&#39;t_tank_up&#39;]]), 0.)</span>
<span class="c1">#</span>
<span class="c1">#             Q_to_set = self.V_upper * self.ro * self.shc * dT</span>
<span class="c1">#</span>
<span class="c1">#             if Q_to_set &lt;= self.Q_nom:</span>
<span class="c1">#                 Q_bckp = Q_to_set</span>
<span class="c1">#                 tank[self.r[&#39;q_unmet&#39;]] = 0.</span>
<span class="c1">#                 tank[self.r[&#39;t_tank_up&#39;]] += dT</span>
<span class="c1">#                 if tank[self.r[&#39;t_tank_up&#39;]] != \</span>
<span class="c1">#                     (self.T_draw_set + dT_dist):</span>
<span class="c1">#                     msg = &#39;Upper tank temperature &#39;\</span>
<span class="c1">#                     &#39;should be at the HW setpoint &#39;\</span>
<span class="c1">#                     &#39;since the backup was capable of reaching it.&#39;\</span>
<span class="c1">#                     &#39; Check draw setpoint T: {}, distribution T drop: {}, &#39;\</span>
<span class="c1">#                     &#39;upper tank volume T before backup: {}.&#39;</span>
<span class="c1">#                     log.error(msg.format(self.T_draw_set, dT_dist, \</span>
<span class="c1">#                     tank[self.r[&#39;t_tank_up&#39;]] - dT))</span>
<span class="c1">#             else:</span>
<span class="c1">#                 Q_bckp = self.Q_nom</span>
<span class="c1">#                 tank[self.r[&#39;q_unmet&#39;]] = Q_to_set - self.Q_nom</span>
<span class="c1">#</span>
<span class="c1">#                 dT = Q_bckp/(self.V_upper * self.ro * self.shc)</span>
<span class="c1">#</span>
<span class="c1">#                 tank[self.r[&#39;t_tank_up&#39;]] = self.T_draw_set + dT_dist</span>
<span class="c1">#</span>
<span class="c1">#             tank[self.r[&#39;q_del_bckp&#39;]] = Q_bckp</span>
<span class="c1">#</span>
<span class="c1">#             if intank_backup == &#39;gas&#39;:</span>
<span class="c1">#                 tank[self.r[&#39;q_gas_use&#39;]] = Q_bckp/gas_comb_eff</span>
<span class="c1">#             elif intank_bakup == &#39;electric&#39;:</span>
<span class="c1">#                 tank[self.r[&#39;q_gas_use&#39;]] = Q_bckp/el_res_eff</span>
<span class="c1">#</span>
<span class="c1">#         # *mg update as needed</span>
<span class="c1">#</span>
<span class="c1">#         # Include all states</span>
<span class="c1">#         res = {self.r[&#39;q_del_sol&#39;] : pre_Q_in,\</span>
<span class="c1">#                self.r[&#39;q_dem&#39;] : tap[&#39;net_dem&#39;],\</span>
<span class="c1">#                self.r[&#39;q_dem_tot&#39;] : tap[&#39;tot_dem&#39;],\</span>
<span class="c1">#                self.r[&#39;q_del_tank&#39;] : tank[self.r[&#39;q_del_tank&#39;]],\</span>
<span class="c1">#                self.r[&#39;q_unmet_tank&#39;] : \</span>
<span class="c1">#                    np.round(\</span>
<span class="c1">#                 tank[self.r[&#39;q_unmet_tank&#39;]] + tap[&#39;unmet_heat_rate&#39;], 2),\</span>
<span class="c1">#                self.r[&#39;q_dump&#39;] : tank[self.r[&#39;q_dump&#39;]],\</span>
<span class="c1">#                self.r[&#39;q_ovrcool_tank&#39;] : tank[self.r[&#39;q_ovrcool_tank&#39;]],\</span>
<span class="c1">#                self.r[&#39;q_dem_balance&#39;] : np.round(Q_dem_balance),\</span>
<span class="c1">#                # to heat source (e.g. collector)</span>
<span class="c1">#                self.r[&#39;t_coil_out&#39;] : T_sol_col_return,\</span>
<span class="c1">#                # average temperatures for tank volumes</span>
<span class="c1">#                self.r[&#39;t_tank_low&#39;] : tank[self.r[&#39;t_tank_low&#39;]],\</span>
<span class="c1">#                self.r[&#39;t_tank_up&#39;] : tank[self.r[&#39;t_tank_up&#39;]],\</span>
<span class="c1">#                self.r[&#39;dt_dist&#39;] : dT_dist,\</span>
<span class="c1">#                self.r[&#39;t_set&#39;] : self.T_draw_set,\</span>
<span class="c1">#                self.r[&#39;q_dist_loss&#39;] : dQ_dist,\</span>
<span class="c1">#                self.r[&#39;flow_on_frac&#39;] : flow_on_timestep_fraction}</span>
<span class="c1">#</span>
<span class="c1"># ----------------------------------------------------------------</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1"># def heat_pump_tank(self, pre_T_amb = 293.15, \</span>
    <span class="c1">#             pre_T_feed = 291.15, \</span>
    <span class="c1">#             pre_T_upper = 328.15, pre_T_lower = 323.15, \</span>
    <span class="c1">#             pre_V_tap = .00757, \</span>
    <span class="c1">#             pre_Q_in = 2350., \</span>
    <span class="c1">#             max_V_tap = 0.1514):</span>
    <span class="c1">#     &quot;&quot;&quot;Model of a thermal storage tank with:</span>
    <span class="c1">#</span>
    <span class="c1">#     * condenser coil acting as heat exchanger for the heat pump gains</span>
    <span class="c1">#     * DHW tap at the top of the tank</span>
    <span class="c1">#     * recharge tap at the bottom of the tank</span>
    <span class="c1">#</span>
    <span class="c1">#     Parameters:</span>
    <span class="c1">#</span>
    <span class="c1">#         pre_T_amb: float, K</span>
    <span class="c1">#             Ambient temperature</span>
    <span class="c1">#</span>
    <span class="c1">#         pre_T_feed: float, K</span>
    <span class="c1">#             Temperature of the water</span>
    <span class="c1">#             that replenishes the tapped volume</span>
    <span class="c1">#             (e.g. water main temperature)</span>
    <span class="c1">#</span>
    <span class="c1">#         pre_T_upper: float, K</span>
    <span class="c1">#             Upper tank volume temperature</span>
    <span class="c1">#</span>
    <span class="c1">#         pre_T_lower: float, K</span>
    <span class="c1">#             Lower tank volume temperature</span>
    <span class="c1">#</span>
    <span class="c1">#         pre_Q_in: float, W</span>
    <span class="c1">#             Heat gain passed to tank from heat pump condenser coil</span>
    <span class="c1">#</span>
    <span class="c1">#         pre_V_tap: float, m3/h</span>
    <span class="c1">#             Volume of water tapped from the top of the tank</span>
    <span class="c1">#</span>
    <span class="c1">#         max_V_tap: float, m3/h</span>
    <span class="c1">#             Annual peak flow</span>
    <span class="c1">#</span>
    <span class="c1">#     Returns:</span>
    <span class="c1">#</span>
    <span class="c1">#         res : dict</span>
    <span class="c1">#             Single timestep input and output values for temperatures [K]</span>
    <span class="c1">#             and heat rates [W]:</span>
    <span class="c1">#</span>
    <span class="c1">#                self.r[&#39;q_del_hp&#39;]</span>
    <span class="c1">#                self.r[&#39;q_loss_low&#39;]</span>
    <span class="c1">#                self.r[&#39;q_loss_up&#39;]</span>
    <span class="c1">#                self.r[&#39;q_dem&#39;]</span>
    <span class="c1">#                self.r[&#39;q_dem_tot&#39;]</span>
    <span class="c1">#                self.r[&#39;q_del_tank&#39;]</span>
    <span class="c1">#                self.r[&#39;q_unmet_tank&#39;]</span>
    <span class="c1">#                self.r[&#39;q_dump&#39;]</span>
    <span class="c1">#                self.r[&#39;q_err_tank&#39;]</span>
    <span class="c1">#                self.r[&#39;q_ovrcool_tank&#39;]</span>
    <span class="c1">#                self.r[&#39;q_dem_balance&#39;]</span>
    <span class="c1">#                self.r[&#39;t_tank_low&#39;]</span>
    <span class="c1">#                self.r[&#39;t_tank_up&#39;]</span>
    <span class="c1">#                self.r[&#39;t_set&#39;]</span>
    <span class="c1">#                self.r[&#39;q_dist_loss&#39;]</span>
    <span class="c1">#</span>
    <span class="c1">#             Temperatures in K, heat rates in W</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1">#     # Heat loss from the upper tank volume</span>
    <span class="c1">#     pre_Q_loss_upper = \</span>
    <span class="c1">#         self._thermal_loss(\</span>
    <span class="c1">#         self.therm_transm_coef, self.A_upper,\</span>
    <span class="c1">#         pre_T_amb, pre_T_upper)</span>
    <span class="c1">#</span>
    <span class="c1">#     # Heat loss from the lower tank volume</span>
    <span class="c1">#     pre_Q_loss_lower = \</span>
    <span class="c1">#         self._thermal_loss(\</span>
    <span class="c1">#         self.therm_transm_coef, self.A_lower,\</span>
    <span class="c1">#         pre_T_amb, pre_T_lower)</span>
    <span class="c1">#</span>
    <span class="c1">#     # temperature drop in the distribution system</span>
    <span class="c1">#     pipe_loss, flow_factor = self.distribution.pipe_losses(\</span>
    <span class="c1">#         T_amb = pre_T_amb, T_in = pre_T_upper)</span>
    <span class="c1">#</span>
    <span class="c1">#     # fraction of timestep during which the flow was on based on</span>
    <span class="c1">#     # nominal flow and peak timestep flows</span>
    <span class="c1">#     flow_on_timestep_fraction = \</span>
    <span class="c1">#         pre_V_tap * flow_factor/(max_V_tap * self.timestep)</span>
    <span class="c1">#</span>
    <span class="c1">#     dQ_dist = pipe_loss[&#39;heat_rate&#39;] * self.timestep *\</span>
    <span class="c1">#         flow_on_timestep_fraction</span>
    <span class="c1">#</span>
    <span class="c1">#     dE_dist = UnitConv(dQ_dist).Wh_J(unit_in = &#39;Wh&#39;)</span>
    <span class="c1">#</span>
    <span class="c1">#     # temperature drop in the distribution system</span>
    <span class="c1">#     # for the timestep draw</span>
    <span class="c1">#     if dE_dist != 0.:</span>
    <span class="c1">#         dT_dist = dE_dist/(self.ro * pre_V_tap * self.shc)</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         dT_dist = 0.</span>
    <span class="c1">#</span>
    <span class="c1">#     # Heat loss due to tapping water from</span>
    <span class="c1">#     # the upper tank volume and</span>
    <span class="c1">#     # replenishing it by water main. This</span>
    <span class="c1">#     # method also calculates any upfront unmet load</span>
    <span class="c1">#     # if the upper tank temperature is below the</span>
    <span class="c1">#     # dhw setpoint + the distribution temperature drop</span>
    <span class="c1">#     tap = self.tap(\</span>
    <span class="c1">#         pre_V_tap, pre_T_upper, pre_T_feed,\</span>
    <span class="c1">#         # dT_loss = dT_loss,\</span>
    <span class="c1">#         dT_loss = dT_dist,\</span>
    <span class="c1">#         # T_draw_min = pre_T_feed + dT_loss)</span>
    <span class="c1">#         T_draw_min = pre_T_feed + dT_dist)</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1">#     pre_Q_tap = tap[&#39;heat_rate&#39;]</span>
    <span class="c1">#</span>
    <span class="c1">#     # run a single timestep of tank behavior</span>
    <span class="c1">#     tank = self.thermal_tank_dynamics(pre_T_amb, \</span>
    <span class="c1">#         pre_T_upper, pre_T_lower, \</span>
    <span class="c1">#         pre_Q_in, pre_Q_loss_upper, pre_Q_loss_lower, \</span>
    <span class="c1">#         pre_T_feed, tap[&#39;heat_rate&#39;])</span>
    <span class="c1">#</span>
    <span class="c1">#     # check total demand balance (compare total heat</span>
    <span class="c1">#     # requirement needed to increase the water temperature of the</span>
    <span class="c1">#     # timestep&#39;s draw volume up to the setpoint temperature increased</span>
    <span class="c1">#     # in any distribution losses with the sum of heat delivered by the</span>
    <span class="c1">#     # tank, heat unmet due to finite tank volume and thermal losses,</span>
    <span class="c1">#     # and heat unmet due to the tank temperature at the upper tank volume)</span>
    <span class="c1">#     Q_del_and_unmet = \</span>
    <span class="c1">#            tank[self.r[&#39;q_del_tank&#39;]] + \</span>
    <span class="c1">#            tank[self.r[&#39;q_unmet_tank&#39;]] + \</span>
    <span class="c1">#            tap[&#39;unmet_heat_rate&#39;]</span>
    <span class="c1">#</span>
    <span class="c1">#     Q_dem_balance = tap[&#39;tot_dem&#39;] - Q_del_and_unmet</span>
    <span class="c1">#</span>
    <span class="c1">#     # Include all states</span>
    <span class="c1">#     res = {self.r[&#39;q_del_hp&#39;] : pre_Q_in,\</span>
    <span class="c1">#            self.r[&#39;q_loss_low&#39;] : pre_Q_loss_lower,\</span>
    <span class="c1">#            self.r[&#39;q_loss_up&#39;] : pre_Q_loss_upper,\</span>
    <span class="c1">#            # demand, delivered and unmet heat</span>
    <span class="c1">#            # (between tap setpoint and water main)</span>
    <span class="c1">#            self.r[&#39;q_dem&#39;] : tap[&#39;net_dem&#39;],\</span>
    <span class="c1">#            self.r[&#39;q_dem_tot&#39;] : tap[&#39;tot_dem&#39;],\</span>
    <span class="c1">#            self.r[&#39;q_del_tank&#39;] : tank[self.r[&#39;q_del_tank&#39;]],\</span>
    <span class="c1">#            self.r[&#39;q_unmet_tank&#39;] : \</span>
    <span class="c1">#                 np.round(\</span>
    <span class="c1">#                 tank[self.r[&#39;q_unmet_tank&#39;]] + tap[&#39;unmet_heat_rate&#39;],2),\</span>
    <span class="c1">#            self.r[&#39;q_dump&#39;] : tank[self.r[&#39;q_dump&#39;]],\</span>
    <span class="c1">#            self.r[&#39;q_ovrcool_tank&#39;] : tank[self.r[&#39;q_ovrcool_tank&#39;]],\</span>
    <span class="c1">#            self.r[&#39;q_dem_balance&#39;] : np.round(Q_dem_balance),\</span>
    <span class="c1">#            # average temperatures for tank volumes</span>
    <span class="c1">#            self.r[&#39;t_tank_low&#39;] : tank[self.r[&#39;t_tank_low&#39;]],\</span>
    <span class="c1">#            self.r[&#39;t_tank_up&#39;] : tank[self.r[&#39;t_tank_up&#39;]],</span>
    <span class="c1">#            self.r[&#39;dt_dist&#39;] : dT_dist,\</span>
    <span class="c1">#            self.r[&#39;t_set&#39;] : self.T_draw_set,\</span>
    <span class="c1">#            self.r[&#39;q_dist_loss&#39;] : dQ_dist,\</span>
    <span class="c1">#            self.r[&#39;flow_on_frac&#39;] : flow_on_timestep_fraction}</span>
    <span class="c1">#</span>
    <span class="c1">#     return res</span>


    <span class="c1"># def simple_thermal_tank(self):</span>
    <span class="c1">#     *mg replace with a system in models.py that uses thermal_tank and</span>
    <span class="c1">#     gas burner as heat input.</span>
    <span class="c1">#</span>
    <span class="c1">#</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Tmax defines Cap_0 (H t max - H t main 0)</span>
    <span class="c1">#     Qdraw each hour</span>
    <span class="c1">#     Charge and discharge one volume only!</span>
    <span class="c1">#     add test with a constant and a solar charge,</span>
    <span class="c1">#     constant and a water main discharge</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     pass</span>


    <span class="k">def</span> <span class="nf">_tank_area</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split_tank</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates tank area associated with</span>
<span class="sd">        thermal losses using the tank volume and a regressed</span>
<span class="sd">        ratio between the tank height and its radius.</span>
<span class="sd">        If the tank is modeled as split into two volumes,</span>
<span class="sd">        it calculates lower and upper tank area based on the</span>
<span class="sd">        fraction of volume assigned to the upper volume.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            split_tank: boolean</span>
<span class="sd">                If true, the method calculates the</span>
<span class="sd">                areas associated with the upper</span>
<span class="sd">                and lower tank volume. If false,</span>
<span class="sd">                it returns the area of the whole tank</span>

<span class="sd">        Returns:</span>

<span class="sd">            areas: float or dict</span>
<span class="sd">                Tank area. If split_tank, the area is</span>
<span class="sd">                split into two areas:</span>
<span class="sd">                &#39;upper&#39; : upper_area</span>
<span class="sd">                &#39;lower&#39; : lower_area</span>

<span class="sd">        Note: We disregard the difference between the</span>
<span class="sd">        internal and the external tank volume.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># radius and height based on their</span>
        <span class="c1"># ratio and tank volume</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cbrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">h_vs_r</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
        <span class="n">hei</span> <span class="o">=</span> <span class="n">rad</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">h_vs_r</span>

        <span class="k">if</span> <span class="n">split_tank</span><span class="p">:</span>

            <span class="n">h_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol_fra_upper</span> <span class="o">*</span> <span class="n">hei</span>
            <span class="n">h_lower</span> <span class="o">=</span> <span class="n">hei</span> <span class="o">-</span> <span class="n">h_upper</span>

            <span class="n">upper_area</span> <span class="o">=</span> <span class="n">rad</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">rad</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">h_upper</span>
            <span class="n">lower_area</span> <span class="o">=</span> <span class="n">rad</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">rad</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">h_lower</span>

            <span class="n">areas</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;upper&#39;</span><span class="p">:</span> <span class="n">upper_area</span><span class="p">,</span>
                     <span class="s1">&#39;lower&#39;</span><span class="p">:</span> <span class="n">lower_area</span><span class="p">}</span>

            <span class="k">return</span> <span class="n">areas</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">area</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">rad</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">rad</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">hei</span>

            <span class="k">return</span> <span class="n">area</span>


<div class="viewcode-block" id="Storage.tap"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Storage.tap">[docs]</a>    <span class="k">def</span> <span class="nf">tap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">V_draw_load</span><span class="p">,</span> <span class="n">T_tank</span><span class="p">,</span> <span class="n">T_feed</span><span class="p">,</span>
            <span class="n">dT_loss</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">T_draw_min</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates the water draw volume and</span>
<span class="sd">        heat content drawn from the top of an infinitely</span>
<span class="sd">        large adiabatic tank given the hot water demand,</span>
<span class="sd">        tank temperature and the water main temperature.</span>

<span class="sd">        It functions somewhat similarly to a</span>
<span class="sd">        thermostatic valve since it regulates the</span>
<span class="sd">        tap flow from the tank as follows:</span>

<span class="sd">            * limits above if the tank temperature</span>
<span class="sd">            is higher than the nominal draw temperature</span>

<span class="sd">            * tap flow equals V_draw_load for any</span>
<span class="sd">            tank temperature between T_draw_min</span>
<span class="sd">            and T_draw_nom</span>

<span class="sd">            * tap flow is zero if tank temperature</span>
<span class="sd">            is below T_draw_min and T_draw_min is</span>
<span class="sd">            provided</span>

<span class="sd">        The results represent the theoretical limit</span>
<span class="sd">        for the draw. The tank model will check if the</span>
<span class="sd">        full amount can be delivered or only a</span>
<span class="sd">        part of the demand, due to the limited</span>
<span class="sd">        tank volume and thermal losses from the tank,</span>
<span class="sd">        and adjust the values.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            V_draw_load: float, m3/h</span>
<span class="sd">                Volume of DHW drawn at the nominal</span>
<span class="sd">                end-use load temperature.</span>

<span class="sd">            T_tank: float, K</span>
<span class="sd">                Tank node temperature from which the</span>
<span class="sd">                DHW is being tapped (usually the</span>
<span class="sd">                upper volume)</span>

<span class="sd">            T_feed: float or array, K</span>
<span class="sd">                Temperature of water heater inlet water</span>

<span class="sd">            dT_loss: float, K</span>
<span class="sd">                Distribution loss temperature difference</span>

<span class="sd">            T_draw_min: float, K</span>
<span class="sd">                Minimal temperature that needs to</span>
<span class="sd">                be achieved in the tank in order</span>
<span class="sd">                to allow tapping.</span>
<span class="sd">                Default: None - tapping is always</span>
<span class="sd">                enabled</span>
<span class="sd">                Recommended usage - in colder climates</span>
<span class="sd">                where an outdoors tank may be cooler</span>
<span class="sd">                than the water main.</span>

<span class="sd">        Returns:</span>

<span class="sd">            draw: dict</span>
<span class="sd">                Draw volume: &#39;vol&#39;, m3/h</span>
<span class="sd">                Total demand heat rate: &#39;tot_dem&#39;, W</span>
<span class="sd">                Infinite volume delivered heat rate: &#39;heat_rate&#39;, W</span>
<span class="sd">                Infinite volume unmet heat rate: &#39;unmet_heat_rate&#39;, W</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get nominal draw temperature</span>
        <span class="n">T_draw_nom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">T_draw_set</span>

        <span class="c1"># draw a volume with the same heat content as</span>
        <span class="c1"># the required load. Enthalpy balance,</span>
        <span class="c1"># assuming c and ro constant</span>
        <span class="k">if</span> <span class="n">T_tank</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">T_draw_nom</span> <span class="o">+</span> <span class="n">dT_loss</span><span class="p">):</span>
            <span class="n">V_tap</span> <span class="o">=</span> <span class="p">(</span><span class="n">V_draw_load</span> <span class="o">*</span>
                     <span class="p">(</span><span class="n">T_draw_nom</span> <span class="o">+</span> <span class="n">dT_loss</span> <span class="o">-</span> <span class="n">T_feed</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">T_tank</span> <span class="o">-</span> <span class="n">T_feed</span><span class="p">))</span>

        <span class="c1"># draw the demand volume if the tank temperature</span>
        <span class="c1"># is below or just at the nominal draw temperature</span>
        <span class="k">elif</span> <span class="n">T_tank</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">T_draw_nom</span> <span class="o">+</span> <span class="n">dT_loss</span><span class="p">):</span>
            <span class="n">V_tap</span> <span class="o">=</span> <span class="n">V_draw_load</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Not able to calculate V_tap based on: &#39;</span>\
                  <span class="s1">&#39;dT_loss = </span><span class="si">{}</span><span class="s1">, T_tank = </span><span class="si">{}</span><span class="s1">, T_draw_nom = </span><span class="si">{}</span><span class="s1">&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dT_loss</span><span class="p">,</span> <span class="n">T_tank</span><span class="p">,</span> <span class="n">T_draw_nom</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="k">if</span> <span class="n">T_draw_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">T_tank</span> <span class="o">&lt;=</span> <span class="n">T_draw_min</span><span class="p">:</span>
                <span class="c1"># do not draw</span>
                <span class="n">V_tap</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="n">Q_dem</span> <span class="o">=</span> <span class="p">(</span><span class="n">UnitConv</span><span class="p">(</span><span class="n">V_draw_load</span><span class="p">)</span><span class="o">.</span><span class="n">m3perh_m3pers</span><span class="p">(</span><span class="n">unit_in</span><span class="o">=</span><span class="s1">&#39;m3perh&#39;</span><span class="p">)</span> <span class="o">*</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">ro</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shc</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_draw_nom</span> <span class="o">-</span> <span class="n">T_feed</span><span class="p">))</span>

        <span class="n">Q_dem_with_dist_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">UnitConv</span><span class="p">(</span><span class="n">V_draw_load</span><span class="p">)</span><span class="o">.</span><span class="n">m3perh_m3pers</span><span class="p">(</span>
            <span class="n">unit_in</span><span class="o">=</span><span class="s1">&#39;m3perh&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ro</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shc</span> <span class="o">*</span>
            <span class="p">(</span><span class="n">T_draw_nom</span> <span class="o">+</span> <span class="n">dT_loss</span> <span class="o">-</span> <span class="n">T_feed</span><span class="p">))</span>

        <span class="n">Q_tap</span> <span class="o">=</span> <span class="p">(</span><span class="n">UnitConv</span><span class="p">(</span><span class="n">V_tap</span><span class="p">)</span><span class="o">.</span><span class="n">m3perh_m3pers</span><span class="p">(</span><span class="n">unit_in</span><span class="o">=</span><span class="s1">&#39;m3perh&#39;</span><span class="p">)</span> <span class="o">*</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">ro</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shc</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_tank</span> <span class="o">-</span> <span class="n">T_feed</span><span class="p">))</span>

        <span class="c1"># rounding</span>
        <span class="k">try</span><span class="p">:</span> <span class="c1"># array</span>
            <span class="n">Q_dem</span> <span class="o">=</span> <span class="n">Q_dem</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">Q_dem_with_dist_loss</span> <span class="o">=</span> <span class="n">Q_dem_with_dist_loss</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">Q_tap</span> <span class="o">=</span> <span class="n">Q_tap</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span> <span class="c1"># float</span>
            <span class="n">Q_dem</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">Q_dem</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">Q_dem_with_dist_loss</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">Q_dem_with_dist_loss</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">Q_tap</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">Q_tap</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">Q_unmet</span> <span class="o">=</span> <span class="n">Q_dem_with_dist_loss</span> <span class="o">-</span> <span class="n">Q_tap</span>

        <span class="n">tap</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;vol&#39;</span><span class="p">:</span> <span class="n">V_tap</span><span class="p">,</span>
               <span class="s1">&#39;tot_dem&#39;</span><span class="p">:</span> <span class="n">Q_dem_with_dist_loss</span><span class="p">,</span>
               <span class="s1">&#39;net_dem&#39;</span><span class="p">:</span> <span class="n">Q_dem</span><span class="p">,</span>
               <span class="s1">&#39;heat_rate&#39;</span><span class="p">:</span> <span class="n">Q_tap</span><span class="p">,</span>
               <span class="s1">&#39;unmet_heat_rate&#39;</span><span class="p">:</span> <span class="n">Q_unmet</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">tap</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_thermal_transmittance</span><span class="p">(</span><span class="n">insul_thickness</span><span class="o">=.</span><span class="mi">04</span><span class="p">,</span> <span class="n">spec_hea_cond</span><span class="o">=.</span><span class="mi">04</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the coefficient</span>
<span class="sd">        of thermal transmittance for the</span>
<span class="sd">        a unit of area of tank wall - U-value.</span>

<span class="sd">        CA Title 24 recommends at least R-12 (ftFh/Btu)</span>
<span class="sd">        for water heater storage tanks and backup tanks;</span>

<span class="sd">        Parameters:</span>

<span class="sd">            insul_thickness: float, m</span>
<span class="sd">                Insulation thickness</span>
<span class="sd">                Default: .04 m (1-2 inch gas,</span>
<span class="sd">                2-3 inch electric, :cite:`WH rule`)</span>

<span class="sd">            spec_hea_cond: float, W/mK</span>
<span class="sd">                Specific heat conductivity</span>
<span class="sd">                of the insulation</span>
<span class="sd">                Default: .04 W/mK (:cite:`ModelicaBuidlings`)</span>

<span class="sd">        Returns:</span>

<span class="sd">            therm_transm_coef: float, W/m2K</span>
<span class="sd">                Heat flow through a meter sqare of</span>
<span class="sd">                the tank wall for each kelvin</span>
<span class="sd">                of temperature difference</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">therm_transm_coef</span> <span class="o">=</span> <span class="n">spec_hea_cond</span><span class="o">/</span><span class="n">insul_thickness</span>

        <span class="k">return</span> <span class="n">therm_transm_coef</span>  <span class="c1"># W/m2K</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_thermal_loss</span><span class="p">(</span><span class="n">therm_transm_coef</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">T_low</span><span class="p">,</span> <span class="n">T_high</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Thermal loss to the environment through the</span>
<span class="sd">        tank walls</span>

<span class="sd">        Parameters:</span>

<span class="sd">            therm_transm_coef: float, W/m2K</span>
<span class="sd">                Heat flow through a meter sqare of</span>
<span class="sd">                the tank wall for each kelvin</span>
<span class="sd">                of temperature difference</span>

<span class="sd">            area: float, m2</span>
<span class="sd">                Wall area</span>

<span class="sd">            T_high: float, K</span>
<span class="sd">                Ambient air temperature</span>

<span class="sd">            T_low: float, K</span>
<span class="sd">                Tank node temperature</span>

<span class="sd">        Returns:</span>

<span class="sd">            Q_loss: float, W</span>
<span class="sd">                Heat loss rate</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">Q_loss</span> <span class="o">=</span> <span class="n">therm_transm_coef</span> <span class="o">*</span> <span class="n">area</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_high</span> <span class="o">-</span> <span class="n">T_low</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Q_loss</span>

<div class="viewcode-block" id="Storage.volume_to_power"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Storage.volume_to_power">[docs]</a>    <span class="k">def</span> <span class="nf">volume_to_power</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tank_volume</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method to convert a gas water heater&#39;s volume input power</span>
<span class="sd">        based on a linear regression of Prospector data.</span>
<span class="sd">        Look in the X drive Data/Water Heaters/Regressions folder</span>
<span class="sd">        for the WaterHeater_ScrapeData_Python.xlsx file.</span>
<span class="sd">        Parameters:</span>

<span class="sd">            tank_volume: float or int</span>
<span class="sd">                Water heater tank volume [m3]</span>

<span class="sd">        Returns</span>

<span class="sd">            tank_input_power: float</span>
<span class="sd">                Water heater input (rated) power [W]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tank_input_power</span> <span class="o">=</span> <span class="p">(</span><span class="mf">63560.</span> <span class="o">*</span> <span class="n">tank_volume</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1777.9</span>

        <span class="k">return</span> <span class="n">tank_input_power</span></div>

<div class="viewcode-block" id="Storage.gas_tank_wh"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Storage.gas_tank_wh">[docs]</a>    <span class="k">def</span> <span class="nf">gas_tank_wh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">V_draw</span><span class="p">,</span> <span class="n">T_feed</span><span class="p">,</span> <span class="n">T_amb</span><span class="o">=</span><span class="mf">291.48</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Gas tank model for state-level analysis based on WHAM equation:</span>

<span class="sd">        Q_dot_cons [W] =</span>
<span class="sd">            (V_dot_draw * rho * c * (T_draw,set - T_feed)) /</span>
<span class="sd">             n_re * (1-(U*A*(T_draw,set - T_amb))/P_rated) +</span>
<span class="sd">            U*A*(T_draw,set - T_amb)</span>

<span class="sd">        Parameters:</span>

<span class="sd">            V_draw: float or array like, m3/h</span>
<span class="sd">                Hourly water draw for a single timestep of</span>
<span class="sd">                an entire analysis period</span>

<span class="sd">            T_feed: float or array like, K</span>
<span class="sd">                Temperature of water heater inlet water for</span>
<span class="sd">                a single timestep of an entire analysis period</span>

<span class="sd">            T_amb: float or array like, K</span>
<span class="sd">                Temperature of space surrounding water heater</span>
<span class="sd">                Default: 65 degF</span>

<span class="sd">        Returns:</span>

<span class="sd">            res: dict</span>
<span class="sd">                self.r[&#39;q_del&#39;] : float, array - delivered heat rate, [W]</span>
<span class="sd">                self.r[&#39;q_dem&#39;] : float, array - demand heat rate, [W]</span>
<span class="sd">                self.r[&#39;q_gas_use&#39;] : float, array - gas use heat rate, [W]</span>
<span class="sd">                self.r[&#39;q_unmet&#39;] : float, array - unmet demand, [w]</span>
<span class="sd">                self.r[&#39;q_dump&#39;] : float, array - dumped heat, [W]</span>

<span class="sd">        Note:</span>

<span class="sd">            Assuming no electricity consumption in this version.</span>

<span class="sd">            Make sure to size the tank according to the recommended</span>
<span class="sd">            sizing rules, since the WHAM model does not apply to</span>
<span class="sd">            tanks that are not appropriately sized.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="n">Q_del</span><span class="p">,</span> <span class="n">Q_gas_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gas_tank_wh</span><span class="p">(</span>
            <span class="n">Q_nom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Q_nom</span><span class="p">,</span>
            <span class="n">V_draw</span><span class="o">=</span><span class="n">V_draw</span><span class="p">,</span>
            <span class="n">tank_V</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span>
            <span class="n">tank_A</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span>
            <span class="n">tank_U</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">therm_transm_coef</span><span class="p">,</span>
            <span class="n">tank_re</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tank_re</span><span class="p">,</span>
            <span class="n">T_set</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">T_draw_set</span><span class="p">,</span>
            <span class="n">T_feed</span><span class="o">=</span><span class="n">T_feed</span><span class="p">,</span>
            <span class="n">T_amb</span><span class="o">=</span><span class="n">T_amb</span><span class="p">,</span>
            <span class="n">water_density</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ro</span><span class="p">,</span>
            <span class="n">water_specheat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shc</span><span class="p">)</span>

        <span class="n">Q_dem</span> <span class="o">=</span> <span class="n">Q_del</span> <span class="o">*</span> <span class="mf">1.</span>

        <span class="c1"># return the heat rate of heat delivered and gas consumed</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_del&#39;</span><span class="p">]:</span> <span class="n">Q_del</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;gas_use&#39;</span><span class="p">]:</span> <span class="n">Q_gas_use</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;q_dem&#39;</span><span class="p">]:</span> <span class="n">Q_dem</span><span class="p">}</span>

        <span class="k">return</span> <span class="n">res</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_gas_tank_wh</span><span class="p">(</span><span class="n">Q_nom</span><span class="o">=</span><span class="mf">8996.</span><span class="p">,</span> <span class="n">V_draw</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">tank_V</span><span class="o">=.</span><span class="mi">11356</span><span class="p">,</span>
                     <span class="n">tank_A</span><span class="o">=</span><span class="mf">1.3522</span><span class="p">,</span> <span class="n">tank_U</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">tank_re</span><span class="o">=</span><span class="mf">0.78</span><span class="p">,</span>
                     <span class="n">T_set</span><span class="o">=</span><span class="mf">322.039</span><span class="p">,</span> <span class="n">T_feed</span><span class="o">=</span><span class="mf">291.15</span><span class="p">,</span> <span class="n">T_amb</span><span class="o">=</span><span class="mf">291.48</span><span class="p">,</span>
                     <span class="n">water_density</span><span class="o">=</span><span class="mf">998.2</span><span class="p">,</span> <span class="n">water_specheat</span><span class="o">=</span><span class="mf">4180.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Implementation of gas tank water heater</span>
<span class="sd">        based on the WHAM model (J. D. Lutz, C. Dunham Whitehead, A. Lekov,</span>
<span class="sd">        D. Winiarski, and G. Rosenquist, WHAM: A Simplified Energy Consumption Equation for Water Heaters, in 472246,</span>
<span class="sd">        1998, vol. 1, pp. 171183.):</span>

<span class="sd">        Q_dot_cons [W] =</span>
<span class="sd">            = (V_dot_draw * rho * c * (T_draw,set - T_feed)) / n_re</span>
<span class="sd">            * (1-(U*A*(T_draw,set - T_amb))/P_rated)</span>
<span class="sd">            + U*A*(T_draw,set - T_amb)</span>

<span class="sd">        The model in the source cited calculates the total</span>
<span class="sd">        energy consumed during a day of water draw, whereas</span>
<span class="sd">        this model provides a consumption rate in W</span>

<span class="sd">        Parameters:</span>

<span class="sd">            V_draw: float or array like, m3/h</span>
<span class="sd">                Water draw rate</span>
<span class="sd">            Q_nom: float, W</span>
<span class="sd">                Tank nominal power</span>
<span class="sd">            tank_V: float, m3</span>
<span class="sd">                Water tank volume</span>
<span class="sd">            tank_A: float, m2</span>
<span class="sd">                Surface area of water tank</span>
<span class="sd">            tank_U: float, W/m2K</span>
<span class="sd">                Thermal transmittance of water tank</span>
<span class="sd">            tank_re: float</span>
<span class="sd">                Water tank recovery efficiency</span>
<span class="sd">                Default: 0.78</span>
<span class="sd">            T_set: float or array, K</span>
<span class="sd">                Temperature setpoint of water heater</span>
<span class="sd">                Default: 120 degF</span>
<span class="sd">            T_feed: float or array, K</span>
<span class="sd">                Temperature of water heater inlet water</span>
<span class="sd">                Default: 64.4 degF</span>
<span class="sd">            T_amb: float, K</span>
<span class="sd">                Temperature of space surrounding water heater</span>
<span class="sd">                Default: 65 degF</span>
<span class="sd">            water_density: float, kg/m3</span>
<span class="sd">                Density of water</span>
<span class="sd">                Default: 998.2 kg/m3</span>
<span class="sd">            water_specheat: float, J/kgK</span>
<span class="sd">                Specific heat of water</span>
<span class="sd">                Default: 4180. J/kgK</span>

<span class="sd">        Returns:</span>

<span class="sd">            Q_del: float, array, W</span>
<span class="sd">                Delivered heat rate</span>

<span class="sd">            Q_gas_use: float or array, W</span>
<span class="sd">                Gas consumption rate</span>

<span class="sd">        Note:</span>

<span class="sd">            This model, as described in the literature,</span>
<span class="sd">            assumes realistic volume/input power</span>
<span class="sd">            ratios and will not perform as expected outside</span>
<span class="sd">            those.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dT</span> <span class="o">=</span> <span class="p">(</span><span class="n">T_set</span> <span class="o">-</span> <span class="n">T_feed</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span> <span class="c1"># array</span>
            <span class="n">dT</span><span class="p">[</span><span class="n">dT</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="k">except</span><span class="p">:</span> <span class="c1"># float</span>
            <span class="n">dT</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">dT</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

        <span class="c1"># heat delivered to user</span>
        <span class="n">Q_del</span> <span class="o">=</span> <span class="p">(</span><span class="n">UnitConv</span><span class="p">(</span><span class="n">V_draw</span><span class="p">)</span><span class="o">.</span><span class="n">m3perh_m3pers</span><span class="p">(</span><span class="n">unit_in</span><span class="o">=</span><span class="s1">&#39;m3perh&#39;</span><span class="p">)</span> <span class="o">*</span>
                 <span class="n">water_density</span> <span class="o">*</span> <span class="n">water_specheat</span> <span class="o">*</span> <span class="n">dT</span><span class="p">)</span>

        <span class="c1"># energy content of the hot water drawn</span>
        <span class="n">consumption_rate</span> <span class="o">=</span> <span class="n">Q_del</span> <span class="o">/</span> <span class="n">tank_re</span>
        <span class="c1"># to avoid double counting of the loss amount</span>
        <span class="n">thermal_loss_adjustment</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">tank_U</span> <span class="o">*</span> <span class="n">tank_A</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_set</span> <span class="o">-</span> <span class="n">T_amb</span><span class="p">)</span> <span class="o">/</span> <span class="n">Q_nom</span><span class="p">))</span>
        <span class="c1"># thermal loss rate</span>
        <span class="n">thermal_loss_rate</span> <span class="o">=</span> <span class="n">tank_U</span> <span class="o">*</span> <span class="n">tank_A</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_set</span> <span class="o">-</span> <span class="n">T_amb</span><span class="p">)</span>

        <span class="c1"># Average timestep gas use rate in W</span>
        <span class="n">Q_gas_use</span> <span class="o">=</span> <span class="p">(</span><span class="n">consumption_rate</span> <span class="o">*</span> <span class="n">thermal_loss_adjustment</span> <span class="o">+</span>
                     <span class="n">thermal_loss_rate</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Q_del</span><span class="p">,</span> <span class="n">Q_gas_use</span>

<div class="viewcode-block" id="Storage.setup_electric"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Storage.setup_electric">[docs]</a>    <span class="k">def</span> <span class="nf">setup_electric</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Currently not implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_electric</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="n">min_cap</span><span class="p">,</span> <span class="n">charge</span><span class="p">,</span> <span class="n">discharge</span><span class="p">,</span>
                  <span class="n">pre_state_of_charge</span><span class="p">,</span> <span class="n">eff_ch</span><span class="p">,</span> <span class="n">eff_disch</span><span class="p">,</span>
                  <span class="n">eff_sta</span><span class="p">,</span> <span class="n">timestep</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simple electric storage model.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            cap: float, Wh</span>
<span class="sd">                Maximum charge capacity</span>

<span class="sd">            min_cap: float, Wh</span>
<span class="sd">                Minimum charge capacity (not able to usefully</span>
<span class="sd">                discharge below this value)</span>

<span class="sd">            charge: float, W</span>
<span class="sd">                Timestep charge rate</span>

<span class="sd">            discharge: float, Wh</span>
<span class="sd">                Timestep discharge rate</span>

<span class="sd">            pre_state_of_charge: float, Wh</span>
<span class="sd">                State of charge in the previous timestep</span>

<span class="sd">            eff_ch: float</span>
<span class="sd">                Charging efficiency</span>

<span class="sd">            eff_disch: float</span>
<span class="sd">                Discharging efficiency</span>

<span class="sd">            eff_sta: float</span>
<span class="sd">                Stagnation efficiency</span>

<span class="sd">            timestep: float, h</span>
<span class="sd">                Default: 1.</span>

<span class="sd">        Returns:</span>

<span class="sd">            state_of_charge: Wh</span>
<span class="sd">                State of charge at this timestep</span>

<span class="sd">            unmet: float, Wh</span>
<span class="sd">                Unmet demand</span>

<span class="sd">            dumped: float, Wh</span>
<span class="sd">                Dumped demand</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">state_of_charge</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pre_state_of_charge</span> <span class="o">*</span> <span class="n">eff_sta</span> <span class="o">+</span>
            <span class="p">(</span><span class="n">charge</span> <span class="o">*</span> <span class="n">eff_ch</span> <span class="o">-</span> <span class="n">discharge</span> <span class="o">/</span> <span class="n">eff_disch</span><span class="p">)</span> <span class="o">*</span> <span class="n">timestep</span><span class="p">)</span>

        <span class="c1"># charged more than possible</span>
        <span class="k">if</span> <span class="n">state_of_charge</span> <span class="o">&gt;</span> <span class="n">cap</span><span class="p">:</span>
            <span class="n">dumped</span> <span class="o">=</span> <span class="n">state_of_charge</span> <span class="o">-</span> <span class="n">cap</span>
            <span class="n">state_of_charge</span> <span class="o">=</span> <span class="n">cap</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unused</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="c1"># discharged more that possible</span>
        <span class="k">if</span> <span class="n">state_of_charge</span> <span class="o">&lt;</span> <span class="n">min_cap</span><span class="p">:</span>
            <span class="n">unmet</span> <span class="o">=</span> <span class="n">min_cap</span> <span class="o">-</span> <span class="n">state_of_charge</span>
            <span class="n">state_of_charge</span> <span class="o">=</span> <span class="n">min_cap</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unmet</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="k">return</span> <span class="n">state_of_charge</span><span class="p">,</span> <span class="n">unmet</span><span class="p">,</span> <span class="n">dumped</span>

<div class="viewcode-block" id="Storage.electric_tank_wh"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Storage.electric_tank_wh">[docs]</a>    <span class="k">def</span> <span class="nf">electric_tank_wh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Currently not implemented.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="Distribution"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Distribution">[docs]</a><span class="k">class</span> <span class="nc">Distribution</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes performance of distribution system components.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        sizes: pd df</span>
<span class="sd">            Pandas dataframe with component sizes, or 1.</span>

<span class="sd">        fluid_medium: string</span>
<span class="sd">            Default: &#39;water&#39;. No other options implemented</span>

<span class="sd">        timestep: float, h</span>
<span class="sd">            Duration of a single timestep, in hours, defaults to 1.</span>

<span class="sd">        log_level: None or python logger logging level,</span>
<span class="sd">            Default: logging.DEBUG</span>
<span class="sd">            This applies for a subset of the class functionality, mostly</span>
<span class="sd">            used to deprecate logger messages for certain calculations.</span>
<span class="sd">            For Example: log_level = logging.ERROR will only throw error</span>
<span class="sd">            messages and ignore INFO, DEBUG and WARNING.</span>

<span class="sd">    Note:</span>

<span class="sd">        Each component is also implemented as a static method that</span>
<span class="sd">        can be used outside of this framework.</span>

<span class="sd">    Examples:</span>

<span class="sd">        See ```swh.system.tests.test_components``` module and</span>
<span class="sd">        for examples on how to use the methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sizes</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">fluid_medium</span><span class="o">=</span><span class="s1">&#39;water&#39;</span><span class="p">,</span>
                 <span class="n">timestep</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>

        <span class="c1"># log level (e.g. only partial functionality of the class</span>
        <span class="c1"># is being used and one does not desire to see all infos)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="n">log_level</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

        <span class="c1"># extract labels</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">SwhLabels</span><span class="p">()</span><span class="o">.</span><span class="n">set_prod_labels</span><span class="p">()</span>

        <span class="c1"># fluid properties</span>
        <span class="k">if</span> <span class="n">fluid_medium</span> <span class="o">==</span> <span class="s1">&#39;water&#39;</span><span class="p">:</span>
            <span class="c1"># Water properties, :cite:`ASHFund17` 33. table 2</span>
            <span class="c1"># density at 20 degC</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ro</span> <span class="o">=</span> <span class="mf">998.2</span>  <span class="c1"># kg/m3</span>
            <span class="c1"># specific heat content at 20 degC</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shc</span> <span class="o">=</span> <span class="mf">4180.</span>  <span class="c1"># J/(kgK)</span>

        <span class="c1"># extract component parameters</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">use_defaults</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># extract components and their performance parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">components</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># components are listed n the label map - extract each if</span>
            <span class="c1"># present in this list:</span>
            <span class="n">components</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;sol_pump&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;sol_pump&#39;</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_sol_pump</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_sol_pump</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_sol_pump&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_sol_pump&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dist_pump&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dist_pump&#39;</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_dist_pump</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_dist_pump</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_dist_pump&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_dist_pump&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;piping&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;piping&#39;</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;pipe_spec_hea_con&#39;</span><span class="p">]]</span> <span class="o">=</span>\
                    <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;pipe_spec_hea_con&#39;</span><span class="p">],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;pipe_ins_thick&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;pipe_ins_thick&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dia_len_exp&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dia_len_exp&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dia_len_sca&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dia_len_sca&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;discr_diam_m&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                    <span class="nb">eval</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;discr_diam_m&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]])[</span><span class="mi">0</span><span class="p">])</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;flow_factor&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                    <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;flow_factor&#39;</span><span class="p">],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;circ&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                    <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;circ&#39;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;long_br_len_fr&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                    <span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="n">params</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;long_br_len_fr&#39;</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;param_value&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_defaults</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">=</span> <span class="n">timestep</span>

        <span class="c1"># extract component size/capacity (see setter for details)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">sizes</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__size</span>

    <span class="nd">@size</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extracts sizes from a dataframe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">set_sizes</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="c1"># assign unit size, please see individual</span>
            <span class="c1"># methods for any modifications</span>
            <span class="n">set_sizes</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;sol_pump&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">set_sizes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;sol_pump&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                <span class="n">value</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;sol_pump&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dist_pump&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">set_sizes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dist_pump&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                <span class="n">value</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dist_pump&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;piping&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">components</span><span class="p">:</span>
                <span class="n">set_sizes</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;piping&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                <span class="n">value</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">value</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;comp&#39;</span><span class="p">]]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;piping&#39;</span><span class="p">],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;cap&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Provided sizes format is not supported.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__size</span> <span class="o">=</span> <span class="n">set_sizes</span>

<div class="viewcode-block" id="Distribution.pump"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Distribution.pump">[docs]</a>    <span class="k">def</span> <span class="nf">pump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">8760</span><span class="p">),</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;solar&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Solar and distribution pump energy use.</span>
<span class="sd">        Assumes a fixed speed pump.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            on_array: array</span>
<span class="sd">                Pump on/off status for the chosen number of discrete</span>
<span class="sd">                timesteps</span>
<span class="sd">                Default: np.ones(8760) - on for a year in hourly timesteps.</span>

<span class="sd">            role: string</span>
<span class="sd">                &#39;solar&#39; : primary (solar collector) loop</span>
<span class="sd">                &#39;distribution&#39; : secondary (distribution) loop</span>

<span class="sd">        Returns:</span>

<span class="sd">            en_use: float or array like</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;solar&#39;</span><span class="p">:</span>
            <span class="n">role_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;sol_pump&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;distribution&#39;</span><span class="p">:</span>
            <span class="n">role_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dist_pump&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">P_nom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="n">role_label</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">P_nom</span> <span class="o">=</span> <span class="mf">1.</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Could not extract &#39;</span> <span class="o">+</span> <span class="n">role</span> <span class="o">+</span> <span class="s1">&#39; pump size. &#39;</span>\
                  <span class="s1">&#39;Setting it to </span><span class="si">{}</span><span class="s1">.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">P_nom</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_defaults</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">role</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span> <span class="o">+</span> \
                  <span class="s1">&#39; pump parameters have not been passed to the&#39;</span>\
                  <span class="s1">&#39; component model. Using defaults.&#39;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">en_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pump</span><span class="p">(</span>
                <span class="n">P_nom</span><span class="o">=</span><span class="n">P_nom</span><span class="p">,</span>
                <span class="n">on_array</span><span class="o">=</span><span class="n">on_array</span><span class="p">,</span>
                <span class="n">timestep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;solar&#39;</span><span class="p">:</span>
            <span class="n">en_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pump</span><span class="p">(</span>
                <span class="n">P_nom</span><span class="o">=</span><span class="n">P_nom</span><span class="p">,</span>
                <span class="n">eta_nom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_sol_pump</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_sol_pump&#39;</span><span class="p">]],</span>
                <span class="n">on_array</span><span class="o">=</span><span class="n">on_array</span><span class="p">,</span>
                <span class="n">timestep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s1">&#39;distribution&#39;</span><span class="p">:</span>
            <span class="n">en_use</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pump</span><span class="p">(</span>
                <span class="n">P_nom</span><span class="o">=</span><span class="n">P_nom</span><span class="p">,</span>
                <span class="n">eta_nom</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_dist_pump</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;eta_dist_pump&#39;</span><span class="p">]],</span>
                <span class="n">on_array</span><span class="o">=</span><span class="n">on_array</span><span class="p">,</span>
                <span class="n">timestep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timestep</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">en_use</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_pump</span><span class="p">(</span><span class="n">P_nom</span><span class="o">=</span><span class="mf">45.</span><span class="p">,</span> <span class="n">eta_nom</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">control</span><span class="o">=</span><span class="s1">&#39;fixed_speed&#39;</span><span class="p">,</span>
              <span class="n">on_array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">8760</span><span class="p">),</span> <span class="n">timestep</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates pump energy use during the operating time.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            P_nom: float</span>
<span class="sd">                Nominal pump power, W</span>

<span class="sd">            eta_nom: float</span>
<span class="sd">                Nominal pump efficiency</span>

<span class="sd">            on_array: array</span>
<span class="sd">                Pump on/off status for the chosen number of discrete</span>
<span class="sd">                timesteps. Each value should belong to interval [0, 1].</span>
<span class="sd">                For example, 0.5 means that the pump was on for half of</span>
<span class="sd">                the timestep.</span>
<span class="sd">                Default: np.ones(8760) - on all the time.</span>

<span class="sd">            control: string, options: &#39;fixed_speed&#39;</span>
<span class="sd">                Pump control type</span>
<span class="sd">                Default: &#39;fixed_speed&#39; - Part load ratio equals 1</span>
<span class="sd">                for all operating hours</span>

<span class="sd">            timestep: float, h</span>
<span class="sd">                Duration of a single timestep in hours</span>

<span class="sd">        Returns:</span>

<span class="sd">            el_use: array, Wh</span>
<span class="sd">                Energy use for each timestep</span>

<span class="sd">            el_use_total: float, Wh</span>
<span class="sd">                Energy use for the duration of the operating time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">control</span> <span class="o">==</span> <span class="s1">&#39;fixed_speed&#39;</span><span class="p">:</span>
            <span class="n">el_use</span> <span class="o">=</span> <span class="n">P_nom</span> <span class="o">*</span> <span class="n">on_array</span> <span class="o">/</span> <span class="n">eta_nom</span>

        <span class="n">el_use_total</span> <span class="o">=</span> <span class="n">el_use</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="n">timestep</span>

        <span class="k">return</span> <span class="n">el_use</span><span class="p">,</span> <span class="n">el_use_total</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_dc_to_ac</span><span class="p">(</span><span class="n">in_power</span><span class="p">,</span> <span class="n">conv_eff</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Models the performance of the</span>
<span class="sd">        DC - AC conversion, including</span>
<span class="sd">        inverter, cable and any other</span>
<span class="sd">        conversion related losses.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            in_power: float</span>
<span class="sd">                Input power of DC electricity [W, kW]</span>

<span class="sd">            conv_eff: float</span>
<span class="sd">                Total efficiency of the dc-ac conversion</span>
<span class="sd">                Default: 0.8</span>

<span class="sd">        Returns:</span>

<span class="sd">            out_power: float</span>
<span class="sd">                Output power of AC electricity [W, kW]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Calculate the output power</span>
        <span class="n">out_power</span> <span class="o">=</span> <span class="n">conv_eff</span> <span class="o">*</span> <span class="n">in_power</span>

        <span class="k">return</span> <span class="n">out_power</span>


<div class="viewcode-block" id="Distribution.pipe_losses"><a class="viewcode-back" href="../../../source/mswh.system.html#mswh.system.components.Distribution.pipe_losses">[docs]</a>    <span class="k">def</span> <span class="nf">pipe_losses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T_in</span><span class="o">=</span><span class="mf">333.15</span><span class="p">,</span> <span class="n">T_amb</span><span class="o">=</span><span class="mf">293.15</span><span class="p">,</span>
                    <span class="n">V_tap</span><span class="o">=.</span><span class="mi">05</span><span class="p">,</span> <span class="n">max_V_tap</span><span class="o">=</span><span class="mf">0.1514</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Thermal losses from distribution pipes.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            T_in: float, K</span>
<span class="sd">                Hot water temperature at distribution pipe inlet</span>

<span class="sd">            T_amb: float, K</span>
<span class="sd">                Ambient temperature</span>

<span class="sd">            V_tap: float, m3/h</span>
<span class="sd">                Timestep draw volume</span>

<span class="sd">            max_V_tap: float, m3/h</span>
<span class="sd">                Maximum draw volume, m3/h (design variable)</span>

<span class="sd">        Returns:</span>

<span class="sd">            res: dict</span>
<span class="sd">                [&#39;heat_rate&#39;]: Loss heat rate, W</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># *mg move over, confirm results</span>
        <span class="c1"># introduce avg temp and adjust flow_factor for state level</span>
        <span class="c1"># update pipe sizing</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_defaults</span><span class="p">:</span>

            <span class="n">diameter</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dia_len_sca&#39;</span><span class="p">]]</span> <span class="o">*</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;piping&#39;</span><span class="p">]]</span> <span class="o">**</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;dia_len_exp&#39;</span><span class="p">]])</span>

            <span class="n">discrete_diameters_m</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;discr_diam_m&#39;</span><span class="p">]])</span>

            <span class="n">diameter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pick_first_larger_size</span><span class="p">(</span>
                <span class="n">diameter</span><span class="p">,</span>
                <span class="n">discrete_diameters_m</span><span class="p">,</span>
                <span class="n">limits</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">loss_heat_rate</span><span class="p">,</span> <span class="n">heat_loss</span><span class="p">,</span> <span class="n">dT_drop</span><span class="p">,</span> <span class="n">flow_on_timestep_fraction</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">_pipe_losses</span><span class="p">(</span>
                    <span class="n">T_in</span><span class="o">=</span><span class="n">T_in</span><span class="p">,</span>
                    <span class="n">T_amb</span><span class="o">=</span><span class="n">T_amb</span><span class="p">,</span>
                    <span class="n">length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;piping&#39;</span><span class="p">]],</span>
                    <span class="n">diameter</span><span class="o">=</span><span class="n">diameter</span><span class="p">,</span>
                    <span class="n">insul_thickness</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;pipe_ins_thick&#39;</span><span class="p">]],</span>
                    <span class="n">spec_hea_cond</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;pipe_spec_hea_con&#39;</span><span class="p">]],</span>
                    <span class="n">V_tap</span><span class="o">=</span><span class="n">V_tap</span><span class="p">,</span>
                    <span class="n">max_V_tap</span><span class="o">=</span><span class="n">max_V_tap</span><span class="p">,</span>
                    <span class="n">flow_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;flow_factor&#39;</span><span class="p">]],</span>
                    <span class="n">circulation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;circ&#39;</span><span class="p">]],</span>
                    <span class="n">longest_branch_length_ratio</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params_piping</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;long_br_len_fr&#39;</span><span class="p">]])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss_heat_rate</span><span class="p">,</span> <span class="n">heat_loss</span><span class="p">,</span> <span class="n">dT_drop</span><span class="p">,</span> <span class="n">flow_on_timestep_fraction</span> <span class="o">=</span>\
                <span class="bp">self</span><span class="o">.</span><span class="n">_pipe_losses</span><span class="p">(</span><span class="n">T_in</span><span class="o">=</span><span class="n">T_in</span><span class="p">,</span> <span class="n">T_amb</span><span class="o">=</span><span class="n">T_amb</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;heat_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loss_heat_rate</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;dt_dist&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dT_drop</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;heat_loss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">heat_loss</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;flow_on_frac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flow_on_timestep_fraction</span>

        <span class="k">return</span> <span class="n">res</span></div>

    <span class="k">def</span> <span class="nf">_pipe_losses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">T_in</span><span class="o">=</span><span class="mf">333.15</span><span class="p">,</span> <span class="n">T_amb</span><span class="o">=</span><span class="mf">293.15</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">20.</span><span class="p">,</span>
                     <span class="n">diameter</span><span class="o">=</span><span class="mf">0.0381</span><span class="p">,</span> <span class="n">insul_thickness</span><span class="o">=.</span><span class="mi">008</span><span class="p">,</span>
                     <span class="n">spec_hea_cond</span><span class="o">=.</span><span class="mi">0175</span><span class="p">,</span> <span class="n">V_tap</span><span class="o">=.</span><span class="mi">00757</span><span class="p">,</span>
                     <span class="n">max_V_tap</span><span class="o">=</span><span class="mf">0.1514</span><span class="p">,</span> <span class="n">flow_factor</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                     <span class="n">circulation</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">longest_branch_length_ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For the distribution piping network estimates:</span>
<span class="sd">        * heat loss rate</span>
<span class="sd">        * timestep heat loss</span>
<span class="sd">        * pipe temperature drop assuming flow through the</span>
<span class="sd">          full provided pipe length</span>

<span class="sd">        Parameters:</span>

<span class="sd">            T_in: float</span>
<span class="sd">                Pipe inlet tempearture, K</span>

<span class="sd">            T_amb: float</span>
<span class="sd">                Pipe outlet temperature, K</span>

<span class="sd">            length: float</span>
<span class="sd">                Pipe length, m</span>

<span class="sd">            diameter: float</span>
<span class="sd">                Pipe diameter, m</span>

<span class="sd">            insul_thickness: float, m</span>
<span class="sd">                Insulation thickness</span>
<span class="sd">                Default: .008 m</span>

<span class="sd">            spec_hea_cond: float, W/mK</span>
<span class="sd">                Specific heat conductivity of the insulation</span>
<span class="sd">                Default: .0175 W/mK</span>

<span class="sd">            V_tap: float, m3/h</span>
<span class="sd">                Timestep draw volume</span>

<span class="sd">            max_V_tap: float, m3/h</span>
<span class="sd">                Maximum draw volume, m3/h (design variable)</span>

<span class="sd">            flow_factor: float</span>
<span class="sd">                Multiplier to account for:</span>
<span class="sd">                    - Intial peak sizing. If equal 1. the pipe is sized such</span>
<span class="sd">                    that maximum hourly flow in a representative year equals</span>
<span class="sd">                    pipe design flow. Values &lt; 1. represent oversizing.</span>

<span class="sd">                    - For large distribution networks a higher</span>
<span class="sd">                    flow_factor can be used to account for</span>
<span class="sd">                    any heated volume that remains stagnant in the</span>
<span class="sd">                    pipe after a draw</span>

<span class="sd">            longest_branch_length_ratio: float or None</span>
<span class="sd">                If the network has a number of paralel branches rather than</span>
<span class="sd">                one main pipe or a circulaton pipe, provide the ratio between</span>
<span class="sd">                the length of the longest pipe and the total pipe length. It</span>
<span class="sd">                gets used in the average pipe temperature and temperature</span>
<span class="sd">                drop estimation.</span>
<span class="sd">                Default: None (equivalent to 1.)</span>

<span class="sd">            circulation: boolean</span>
<span class="sd">                True: has circulation</span>

<span class="sd">        Returns:</span>

<span class="sd">            loss_heat_rate: float, W</span>
<span class="sd">                Heat loss rate from the pipe</span>

<span class="sd">            heat_loss: float, Wh</span>
<span class="sd">                Heat lost from the pipe for the</span>
<span class="sd">                duration of a single timestep</span>

<span class="sd">            dT_drop: float, K</span>
<span class="sd">                Estimated temperature drop through the</span>
<span class="sd">                entire length of the pipe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">length</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
            <span class="n">U_value</span> <span class="o">=</span> <span class="n">spec_hea_cond</span> <span class="o">/</span> <span class="n">insul_thickness</span>

            <span class="c1"># fraction of timestep during which the flow was on</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">circulation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">flow_on_timestep_fraction</span> <span class="o">=</span> <span class="mf">1.</span>
                <span class="c1"># assuming constant nominal speed circulation</span>
                <span class="n">V_tap</span> <span class="o">=</span> <span class="n">max_V_tap</span> <span class="o">/</span> <span class="n">flow_factor</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># at some constant nominal pump speed only the tapped</span>
                <span class="c1"># volume of water is assumed to flow through the pipe,</span>
                <span class="c1"># which lasts for a fraction of the timestep:</span>
                <span class="n">flow_on_timestep_fraction</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">V_tap</span> <span class="o">*</span> <span class="n">flow_factor</span> <span class="o">/</span> <span class="n">max_V_tap</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">V_tap</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="c1"># effective flowrate [in m3/s] to calculate average pipe</span>
                <span class="c1"># temperature and temperature drop</span>
                <span class="n">V_eff</span> <span class="o">=</span> <span class="p">(</span><span class="n">V_tap</span> <span class="o">/</span> <span class="n">flow_on_timestep_fraction</span><span class="p">)</span> <span class="o">/</span> <span class="mf">3600.</span>
                <span class="c1"># the same as</span>
                <span class="c1"># V_eff = (max_V_tap/flow_factor)/3600.</span>

                <span class="c1"># area</span>
                <span class="k">if</span> <span class="n">longest_branch_length_ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">length_eff</span> <span class="o">=</span> <span class="n">longest_branch_length_ratio</span> <span class="o">*</span> <span class="n">length</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">length_eff</span> <span class="o">=</span> <span class="n">length</span> <span class="o">*</span> <span class="mf">1.</span>

                <span class="n">area_for_t_avg</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">diameter</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">insul_thickness</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">length_eff</span>

                <span class="c1"># average pipe temperature</span>
                <span class="c1"># derived using equations from</span>
                <span class="c1"># Incropera/DeWitt/Bergman/Lavine:</span>
                <span class="c1"># Fundamentals of Heat and Mass Transfer</span>
                <span class="n">k</span> <span class="o">=</span> <span class="n">U_value</span> <span class="o">*</span> <span class="n">area_for_t_avg</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ro</span> <span class="o">*</span> <span class="n">V_eff</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shc</span><span class="p">)</span>

                <span class="n">T_avg</span> <span class="o">=</span> <span class="p">(</span><span class="n">T_in</span> <span class="o">-</span> <span class="n">T_amb</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">k</span><span class="p">))</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">T_amb</span>

                <span class="n">loss_heat_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pipe_loss_rate</span><span class="p">(</span>
                    <span class="n">T_avg</span><span class="o">=</span><span class="n">T_avg</span><span class="p">,</span>
                    <span class="n">T_amb</span><span class="o">=</span><span class="n">T_amb</span><span class="p">,</span>
                    <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span>
                    <span class="n">diameter</span><span class="o">=</span><span class="n">diameter</span><span class="p">,</span>
                    <span class="n">U_value</span><span class="o">=</span><span class="n">U_value</span><span class="p">)</span>

                <span class="c1"># estimated temperature drop in the distribution system</span>
                <span class="k">if</span> <span class="n">V_tap</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
                    <span class="n">dT_drop</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss_heat_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">length_eff</span> <span class="o">/</span> <span class="n">length</span><span class="p">)</span> <span class="o">/</span>
                               <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ro</span> <span class="o">*</span> <span class="n">V_eff</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">shc</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dT_drop</span> <span class="o">=</span> <span class="mf">0.</span>

                <span class="c1"># Heat loss in Wh during the timestep [h]</span>
                <span class="n">heat_loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">loss_heat_rate</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestep</span> <span class="o">*</span>
                             <span class="n">flow_on_timestep_fraction</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">loss_heat_rate</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">heat_loss</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">dT_drop</span> <span class="o">=</span> <span class="mf">0.</span>
                <span class="n">flow_on_timestep_fraction</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">loss_heat_rate</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">heat_loss</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">dT_drop</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="n">flow_on_timestep_fraction</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="k">return</span> <span class="n">loss_heat_rate</span><span class="p">,</span> <span class="n">heat_loss</span><span class="p">,</span> <span class="n">dT_drop</span><span class="p">,</span> <span class="n">flow_on_timestep_fraction</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_pipe_loss_rate</span><span class="p">(</span><span class="n">T_avg</span><span class="o">=</span><span class="mf">333.15</span><span class="p">,</span> <span class="n">T_amb</span><span class="o">=</span><span class="mf">293.15</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mf">20.</span><span class="p">,</span>
                        <span class="n">diameter</span><span class="o">=</span><span class="mf">0.0381</span><span class="p">,</span> <span class="n">U_value</span><span class="o">=</span><span class="mf">2.1875</span><span class="p">,</span>
                        <span class="n">insul_thickness</span><span class="o">=.</span><span class="mi">008</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Thermal losses from distribution pipes.</span>
<span class="sd">        Approximates the thermal loss as the product of U-value,</span>
<span class="sd">        total pipe area and the difference between</span>
<span class="sd">        average pipe and the ambient temperatures.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            T_avg: float, K</span>
<span class="sd">                Average hot water distribution pipe temperature.</span>

<span class="sd">                To estimate losses without any flow information one</span>
<span class="sd">                could, given one knows the tank outlet (pipe inlet)</span>
<span class="sd">                temperature, pass pipe inlet temperature instead of pipe</span>
<span class="sd">                average temperature, which would yield losses slightly</span>
<span class="sd">                higher than actual, but may be a useful conservative</span>
<span class="sd">                first approximation.</span>

<span class="sd">            T_amb: float, K</span>
<span class="sd">                Ambient temperature</span>

<span class="sd">            length: float, m</span>
<span class="sd">                Total length of pipes</span>

<span class="sd">            diameter: float, m</span>
<span class="sd">                Pipe diameter</span>

<span class="sd">            U_value: float, W/m2K</span>
<span class="sd">                U value of the pipe (coefficient of thermal transmittance)</span>

<span class="sd">            insul_thickness: float, m</span>
<span class="sd">                Insulation thickness</span>
<span class="sd">                Default: .008 m</span>

<span class="sd">        Returns:</span>

<span class="sd">            loss_heat_rate: float, W</span>
<span class="sd">                Thermal loss rate from the pipes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pipe area</span>
        <span class="n">area</span> <span class="o">=</span> <span class="p">(</span><span class="n">diameter</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">insul_thickness</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">length</span>

        <span class="c1"># pipe heat loss rate</span>
        <span class="n">loss_heat_rate</span> <span class="o">=</span> <span class="n">area</span> <span class="o">*</span> <span class="n">U_value</span> <span class="o">*</span> <span class="p">(</span><span class="n">T_avg</span> <span class="o">-</span> <span class="n">T_amb</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">loss_heat_rate</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_pick_first_larger_size</span><span class="p">(</span><span class="n">theor_size</span><span class="p">,</span> <span class="n">discrete_sizes</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extracts the smallest discrete size larger than the</span>
<span class="sd">        theoretically required size.</span>

<span class="sd">        Parameters:</span>

<span class="sd">            theor_size: float, list</span>
<span class="sd">                Theoretically required component size (defined e.g. using</span>
<span class="sd">                a rule of a thumb, a fit, or based on the load</span>
<span class="sd">                characteristics)</span>

<span class="sd">            discrete_sizes: numpy array</span>
<span class="sd">                An array of market available component sizes</span>

<span class="sd">            limits: boolean</span>
<span class="sd">                If theor_size less than min or larger than max, pick</span>
<span class="sd">                the limit</span>

<span class="sd">        Returns:</span>

<span class="sd">            result: float</span>
<span class="sd">                First larger market available size</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">discrete_sizes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="n">discrete_sizes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">discrete_sizes</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">theor_size</span> <span class="o">&gt;</span> <span class="n">discrete_sizes</span><span class="o">.</span><span class="n">max</span><span class="p">():</span>
            <span class="n">result</span> <span class="o">=</span>  <span class="n">discrete_sizes</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">discrete_sizes</span><span class="p">[</span><span class="n">theor_size</span> <span class="o">&lt;=</span> <span class="n">discrete_sizes</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 
Multiscale Solar Water Heating (MSWH) Copyright (c) 2019, The
Regents of the University of California, through Lawrence Berkeley National
Laboratory (subject to receipt of any required approvals from the U.S.
Dept. of Energy).  All rights reserved.

If you have questions about your rights to use or distribute this software,
please contact Berkeley Lab&#39;s Intellectual Property Office at
IPO@lbl.gov.

NOTICE.  This Software was developed under funding from the U.S. Department
of Energy and the U.S. Government consequently retains certain rights.  As
such, the U.S. Government has been granted for itself and others acting on
its behalf a paid-up, nonexclusive, irrevocable, worldwide license in the
Software to reproduce, distribute copies to the public, prepare derivative
works, and perform publicly and display publicly, and to permit other to do
so.


    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>